<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>include\service\entities\template_service.js - PencilBlue</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://pencilblue.org/img/pb_logo.png" title="PencilBlue"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.4.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AdminChangePasswordController.html">AdminChangePasswordController</a></li>
            
                <li><a href="../classes/AdminIndexController.html">AdminIndexController</a></li>
            
                <li><a href="../classes/AdminNavigation.html">AdminNavigation</a></li>
            
                <li><a href="../classes/AdminSubnavService.html">AdminSubnavService</a></li>
            
                <li><a href="../classes/AnalyticsManager.html">AnalyticsManager</a></li>
            
                <li><a href="../classes/ApiActionController.html">ApiActionController</a></li>
            
                <li><a href="../classes/ArticleService.html">ArticleService</a></li>
            
                <li><a href="../classes/AsyncJobRunner.html">AsyncJobRunner</a></li>
            
                <li><a href="../classes/BaseBodyParser.html">BaseBodyParser</a></li>
            
                <li><a href="../classes/BaseController.html">BaseController</a></li>
            
                <li><a href="../classes/BaseMediaRenderer.html">BaseMediaRenderer</a></li>
            
                <li><a href="../classes/CacheEntityService.html">CacheEntityService</a></li>
            
                <li><a href="../classes/CacheFactory.html">CacheFactory</a></li>
            
                <li><a href="../classes/CallHomeService.html">CallHomeService</a></li>
            
                <li><a href="../classes/ChangePasswordFormController.html">ChangePasswordFormController</a></li>
            
                <li><a href="../classes/ClientJs.html">ClientJs</a></li>
            
                <li><a href="../classes/ClusterApiController.html">ClusterApiController</a></li>
            
                <li><a href="../classes/ClusterJobRunner.html">ClusterJobRunner</a></li>
            
                <li><a href="../classes/CommandService.html">CommandService</a></li>
            
                <li><a href="../classes/CommentService.html">CommentService</a></li>
            
                <li><a href="../classes/ContentService.html">ContentService</a></li>
            
                <li><a href="../classes/CustomObjectService.html">CustomObjectService</a></li>
            
                <li><a href="../classes/DailyMotionMediaRenderer.html">DailyMotionMediaRenderer</a></li>
            
                <li><a href="../classes/DAO.html">DAO</a></li>
            
                <li><a href="../classes/DbEntityService.html">DbEntityService</a></li>
            
                <li><a href="../classes/DBManager.html">DBManager</a></li>
            
                <li><a href="../classes/DeleteArticleActionController.html">DeleteArticleActionController</a></li>
            
                <li><a href="../classes/DeleteMediaController.html">DeleteMediaController</a></li>
            
                <li><a href="../classes/DocumentCreator.html">DocumentCreator</a></li>
            
                <li><a href="../classes/EditMediaActionController.html">EditMediaActionController</a></li>
            
                <li><a href="../classes/EditObject.html">EditObject</a></li>
            
                <li><a href="../classes/EditObjectType.html">EditObjectType</a></li>
            
                <li><a href="../classes/EmailService.html">EmailService</a></li>
            
                <li><a href="../classes/ErrorsOverTime.html">ErrorsOverTime</a></li>
            
                <li><a href="../classes/ForgotPasswordController.html">ForgotPasswordController</a></li>
            
                <li><a href="../classes/FormAuthentication.html">FormAuthentication</a></li>
            
                <li><a href="../classes/FormBodyParser.html">FormBodyParser</a></li>
            
                <li><a href="../classes/FormController.html">FormController</a></li>
            
                <li><a href="../classes/FSEntityService.html">FSEntityService</a></li>
            
                <li><a href="../classes/FsMediaProvider.html">FsMediaProvider</a></li>
            
                <li><a href="../classes/GetMediaEmbedApiController.html">GetMediaEmbedApiController</a></li>
            
                <li><a href="../classes/GetMediaLinkApiController.html">GetMediaLinkApiController</a></li>
            
                <li><a href="../classes/GetMediaPreviewApiController.html">GetMediaPreviewApiController</a></li>
            
                <li><a href="../classes/HomePageSettings.html">HomePageSettings</a></li>
            
                <li><a href="../classes/ImageMediaRenderer.html">ImageMediaRenderer</a></li>
            
                <li><a href="../classes/ImportTopics.html">ImportTopics</a></li>
            
                <li><a href="../classes/ImportWPActionController.html">ImportWPActionController</a></li>
            
                <li><a href="../classes/Index.html">Index</a></li>
            
                <li><a href="../classes/InstagramMediaRenderer.html">InstagramMediaRenderer</a></li>
            
                <li><a href="../classes/JobApiController.html">JobApiController</a></li>
            
                <li><a href="../classes/JobRunner.html">JobRunner</a></li>
            
                <li><a href="../classes/JobService.html">JobService</a></li>
            
                <li><a href="../classes/JsonBodyParser.html">JsonBodyParser</a></li>
            
                <li><a href="../classes/JSONFSEntityService.html">JSONFSEntityService</a></li>
            
                <li><a href="../classes/KickStarterMediaRenderer.html">KickStarterMediaRenderer</a></li>
            
                <li><a href="../classes/LibrariesService.html">LibrariesService</a></li>
            
                <li><a href="../classes/Localization.html">Localization</a></li>
            
                <li><a href="../classes/LocalizationApiController.html">LocalizationApiController</a></li>
            
                <li><a href="../classes/LoginActionController.html">LoginActionController</a></li>
            
                <li><a href="../classes/LoginViewController.html">LoginViewController</a></li>
            
                <li><a href="../classes/LogoutController.html">LogoutController</a></li>
            
                <li><a href="../classes/ManageComments.html">ManageComments</a></li>
            
                <li><a href="../classes/ManageObjects.html">ManageObjects</a></li>
            
                <li><a href="../classes/ManageObjectTypes.html">ManageObjectTypes</a></li>
            
                <li><a href="../classes/MediaContentController.html">MediaContentController</a></li>
            
                <li><a href="../classes/MediaForm.html">MediaForm</a></li>
            
                <li><a href="../classes/MediaLoader.html">MediaLoader</a></li>
            
                <li><a href="../classes/MediaService.html">MediaService</a></li>
            
                <li><a href="../classes/MemoryEntityService.html">MemoryEntityService</a></li>
            
                <li><a href="../classes/MongoCommandBroker.html">MongoCommandBroker</a></li>
            
                <li><a href="../classes/MongoMediaProvider.html">MongoMediaProvider</a></li>
            
                <li><a href="../classes/MongoRegistrationProvider.html">MongoRegistrationProvider</a></li>
            
                <li><a href="../classes/MongoSessionStore.html">MongoSessionStore</a></li>
            
                <li><a href="../classes/NavItemFormController.html">NavItemFormController</a></li>
            
                <li><a href="../classes/NewMediaApiController.html">NewMediaApiController</a></li>
            
                <li><a href="../classes/NewObjectActionController.html">NewObjectActionController</a></li>
            
                <li><a href="../classes/NewObjectTypeActionController.html">NewObjectTypeActionController</a></li>
            
                <li><a href="../classes/NewPagePostController.html">NewPagePostController</a></li>
            
                <li><a href="../classes/NotFoundController.html">NotFoundController</a></li>
            
                <li><a href="../classes/ObjectFormController.html">ObjectFormController</a></li>
            
                <li><a href="../classes/PageController.html">PageController</a></li>
            
                <li><a href="../classes/PBError.html">PBError</a></li>
            
                <li><a href="../classes/PencilBlue.html">PencilBlue</a></li>
            
                <li><a href="../classes/PluginApi.html">PluginApi</a></li>
            
                <li><a href="../classes/PluginAvailableJob.html">PluginAvailableJob</a></li>
            
                <li><a href="../classes/PluginDependenciesJob.html">PluginDependenciesJob</a></li>
            
                <li><a href="../classes/PluginDetailsViewController.html">PluginDetailsViewController</a></li>
            
                <li><a href="../classes/PluginInitializeJob.html">PluginInitializeJob</a></li>
            
                <li><a href="../classes/PluginInstallJob.html">PluginInstallJob</a></li>
            
                <li><a href="../classes/PluginJobRunner.html">PluginJobRunner</a></li>
            
                <li><a href="../classes/PluginPublicContentController.html">PluginPublicContentController</a></li>
            
                <li><a href="../classes/PluginService.html">PluginService</a></li>
            
                <li><a href="../classes/PluginSettingsFormController.html">PluginSettingsFormController</a></li>
            
                <li><a href="../classes/PluginUninstallJob.html">PluginUninstallJob</a></li>
            
                <li><a href="../classes/RandomTextViewController.html">RandomTextViewController</a></li>
            
                <li><a href="../classes/ReadOnlySimpleLayeredService.html">ReadOnlySimpleLayeredService</a></li>
            
                <li><a href="../classes/RedisCommandBroker.html">RedisCommandBroker</a></li>
            
                <li><a href="../classes/RedisRegistrationProvider.html">RedisRegistrationProvider</a></li>
            
                <li><a href="../classes/RedisSessionStore.html">RedisSessionStore</a></li>
            
                <li><a href="../classes/RequestHandler.html">RequestHandler</a></li>
            
                <li><a href="../classes/SaveHomePageSettings.html">SaveHomePageSettings</a></li>
            
                <li><a href="../classes/SectionService.html">SectionService</a></li>
            
                <li><a href="../classes/SecurityService.html">SecurityService</a></li>
            
                <li><a href="../classes/ServerRegistration.html">ServerRegistration</a></li>
            
                <li><a href="../classes/SessionHandler.html">SessionHandler</a></li>
            
                <li><a href="../classes/SettingsServiceFactory.html">SettingsServiceFactory</a></li>
            
                <li><a href="../classes/SetupActionController.html">SetupActionController</a></li>
            
                <li><a href="../classes/SetupViewController.html">SetupViewController</a></li>
            
                <li><a href="../classes/SimpleLayeredService.html">SimpleLayeredService</a></li>
            
                <li><a href="../classes/SlideShareMediaRenderer.html">SlideShareMediaRenderer</a></li>
            
                <li><a href="../classes/SortObjects.html">SortObjects</a></li>
            
                <li><a href="../classes/SortObjectsActionController.html">SortObjectsActionController</a></li>
            
                <li><a href="../classes/StorifyMediaRenderer.html">StorifyMediaRenderer</a></li>
            
                <li><a href="../classes/System.html">System</a></li>
            
                <li><a href="../classes/TemplateEntityService.html">TemplateEntityService</a></li>
            
                <li><a href="../classes/TemplateService.html">TemplateService</a></li>
            
                <li><a href="../classes/TemplateValue.html">TemplateValue</a></li>
            
                <li><a href="../classes/TextService.html">TextService</a></li>
            
                <li><a href="../classes/TopMenuService.html">TopMenuService</a></li>
            
                <li><a href="../classes/TrinketMediaRenderer.html">TrinketMediaRenderer</a></li>
            
                <li><a href="../classes/UploadMediaController.html">UploadMediaController</a></li>
            
                <li><a href="../classes/UrlApiController.html">UrlApiController</a></li>
            
                <li><a href="../classes/UrlService.html">UrlService</a></li>
            
                <li><a href="../classes/UsernamePasswordAuthentication.html">UsernamePasswordAuthentication</a></li>
            
                <li><a href="../classes/UserService.html">UserService</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
                <li><a href="../classes/ValidationService.html">ValidationService</a></li>
            
                <li><a href="../classes/VideoMediaRenderer.html">VideoMediaRenderer</a></li>
            
                <li><a href="../classes/View Controller.html">View Controller</a></li>
            
                <li><a href="../classes/VimeoMediaRenderer.html">VimeoMediaRenderer</a></li>
            
                <li><a href="../classes/VineMediaRenderer.html">VineMediaRenderer</a></li>
            
                <li><a href="../classes/WPXMLParseService.html">WPXMLParseService</a></li>
            
                <li><a href="../classes/YouTubeMediaRenderer.html">YouTubeMediaRenderer</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Admin.html">Admin</a></li>
            
                <li><a href="../modules/dao.html">dao</a></li>
            
                <li><a href="../modules/Database.html">Database</a></li>
            
                <li><a href="../modules/Entities.html">Entities</a></li>
            
                <li><a href="../modules/ErrorSuccess.html">ErrorSuccess</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/Security.html">Security</a></li>
            
                <li><a href="../modules/Services.html">Services</a></li>
            
                <li><a href="../modules/Session.html">Session</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/Theme.html">Theme</a></li>
            
                <li><a href="../modules/Validation.html">Validation</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: include\service\entities\template_service.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Copyright (C) 2015  PencilBlue, LLC

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/

//dependencies
var path        = require(&#x27;path&#x27;);
var async       = require(&#x27;async&#x27;);
var HtmlEncoder = require(&#x27;htmlencode&#x27;);
var util        = require(&#x27;../../util.js&#x27;);

module.exports = function(pb) {

    /**
     * A templating engine that provides the ability to read in file snippets and
     * call back for data based on the flags in the template file.  The instance
     * can be provided a Localization instance which will be used to perform
     * translations for localization flags are encountered.  Flags are marked in
     * html files by the pattern ^xzy^.  The values provided here are not HTML
     * encoded.  Any reserved characters must be manually encoded by any flag
     * call backs.
     *
     * @class TemplateService
     * @constructor
     * @module Services
     * @submodule Entities
     * @param {Object} [localizationService] The localization service object
     */
    function TemplateService(localizationService){
        this.localCallbacks      = {
            year: (new Date()).getFullYear()
        };

        this.localizationService = null;
        if (localizationService) {
            this.localizationService = localizationService;
        }

        //set the prioritized template as not specified
        this.theme = null;

        //ensure template loader is initialized
        if (TEMPLATE_LOADER === null) {
            var objType  = &#x27;template&#x27;;
            var services = [];

            //add in-memory service
            if (pb.config.templates.use_memory){
                var options = {
                    objType: objType,
                    timeout: pb.config.templates.memory_timeout
                };
                services.push(new pb.MemoryEntityService(options));
            }

            //add cache service
            if (pb.config.templates.use_cache) {
                services.push(new pb.CacheEntityService(objType));
            }

            //always add fs service
            services.push(new pb.TemplateEntityService());

            TEMPLATE_LOADER = new pb.SimpleLayeredService(services, &#x27;TemplateService&#x27;);
        }

        /**
         * Indicates if the data from the registered flags
         * should be reprocessed.  The value is FALSE by default.
         * @property reprocess
         * @type {Boolean}
         */
        this.reprocess = false;

        /**
         * @property unregisteredFlagTemplate
         * @type {Function}
         */
        this.unregisteredFlagHandler = null;
        
        /**
         * @property pluginService
         * @type {PluginService}
         */
        this.pluginService = new pb.PluginService();
    }

    //constants
    var TEMPLATE_PREFIX         = &#x27;tmp_&#x27;;
    var TEMPLATE_PREFIX_LEN     = TEMPLATE_PREFIX.length;
    var LOCALIZATION_PREFIX     = &#x27;loc_&#x27;;
    var LOCALIZATION_PREFIX_LEN = LOCALIZATION_PREFIX.length;
    var SYSTEM_PREFIX           = &#x27;system_&#x27;;
    var SYSTEM_PREFIX_LEN       = SYSTEM_PREFIX.length;

    var TEMPLATE_LOADER = null;

    var TEMPLATE_PIECE_STATIC = &#x27;static&#x27;;
    var TEMPLATE_PIECE_FLAG   = &#x27;flag&#x27;;

    /**
     * A container that provides the mapping for global call backs.  These should
     * only be added to at the start of the application or on plugin install/update.
     *
     * @private
     * @property
     */
    var GLOBAL_CALLBACKS = {
        site_root: pb.config.siteRoot,
        site_name: pb.config.siteName,
        site_logo: function(flag, callback) {
            pb.settings.get(&#x27;site_logo&#x27;, function(err, logo) {
                callback(null, logo ? logo : &#x27;/img/pb_logo.png&#x27;);
            });
        },
        site_menu_logo: &#x27;/img/logo_menu.png&#x27;,
        site_icon: function(flag, callback) {
            var pluginService = new pb.PluginService();
            pluginService.getActiveIcon(callback);
        },
        version: pb.config.version
    };

    /**
     * The default handler for unregistered flags.  It outputs the flag back out.
     * @property unregisteredFlagHandler
     * @type {Function}
     */
    TemplateService.unregisteredFlagHandler = function(flag, cb) {
        cb(null, &#x27;^&#x27;+flag+&#x27;^&#x27;);
    };

    /**
     * Sets the prioritized theme to use when loading templates
     *
     * @method setTheme
     * @param {string} theme The name of the theme.
     */
    TemplateService.prototype.setTheme = function(theme) {
        this.theme = theme;
    };

    /**
     * Retrieves the prioratized theme
     *
     * @method getTheme
     * @return {string} The prioritized theme to use when loading templates
     */
    TemplateService.prototype.getTheme = function() {
        return this.theme;
    };

    /**
     * When a flag is encountered that is not registered with the engine the 
     * handler is called as a fail safe.  It is expected to return a string that 
     * will be put in the place of the flag.
     *
     * @method setUnregisteredFlagHandler
     * @param {Function} unregisteredFlagHandler
     * @return {Boolean} TRUE when the handler was set, FALSE if not
     */
    TemplateService.prototype.setUnregisteredFlagHandler = function(unregisteredFlagHandler) {
        if (!util.isFunction(unregisteredFlagHandler)) {
            return false;
        }

        this.unregisteredFlagHandler = unregisteredFlagHandler;
        return true;
    };

    /**
     * When a flag is encountered that is not registered with the engine the 
     * handler is called as a fail safe unless there is a locally registered handler.  
     * It is expected to return a string that will be put in the place of the flag.
     *
     * @method setGlobalUnregisteredFlagHandler
     * @param {Function} unregisteredFlagHandler
     * @return {Boolean} TRUE when the handler was set, FALSE if not
     */
    TemplateService.setGlobalUnregisteredFlagHandler = function(unregisteredFlagHandler) {
        if (!util.isFunction(unregisteredFlagHandler)) {
            return false;
        }

        TemplateService.unregisteredFlagHandler = unregisteredFlagHandler;
        return true;
    };

    /**
     * Sets the option that when true, instructs the engine to inspect the content 
     * provided by a flag for more flags.  This is one way of providing iterative 
     * processing of items.  See the sample plugin for an example.
     * @method setReprocess
     * @param {Boolean} reprocess
     */
    TemplateService.prototype.setReprocess = function(reprocess) {
        this.reprocess = reprocess ? true : false;
    };

    /**
     * Retrieves the raw template based on a priority.  The path to the template is
     * derived from the specified relative path and the following order of
     * directories:
     * &lt;ol&gt;
     * &lt;li&gt;The theme provided by &quot;getTheme&quot; if not null&lt;/li&gt;
     * &lt;li&gt;The globally set active_theme&lt;/li&gt;
     * &lt;li&gt;Iterates over the list of active plugins looking for the template&lt;/li&gt;
     * &lt;li&gt;The system template directory&lt;/li&gt;
     * &lt;/ol&gt;
     *
     * @method getTemplateContentsByPriority
     * @param {string} relativePath
     * @param {function} cb Callback function
     */
    TemplateService.prototype.getTemplateContentsByPriority = function(relativePath, cb) {
        var self = this;
        
        //build set of paths to search through
        var hintedTheme   = this.getTheme();
        var paths         = [];
        if (hintedTheme) {
            paths.push(TemplateService.getCustomPath(this.getTheme(), relativePath));
        }
        pb.settings.get(&#x27;active_theme&#x27;, function(err, activeTheme){
            if (activeTheme !== null) {
                paths.push(TemplateService.getCustomPath(activeTheme, relativePath));
            }

            var activePlugins = self.pluginService.getActivePluginNames();
            for (var i = 0; i &lt; activePlugins.length; i++) {
                if (hintedTheme !== activePlugins[i] &amp;&amp; &#x27;pencilblue&#x27; !== activePlugins[i]) {
                    paths.push(TemplateService.getCustomPath(activePlugins[i], relativePath));
                }
            }
            paths.push(TemplateService.getDefaultPath(relativePath));

            //iterate over paths until a valid template is found
            var i        = 0;
            var doLoop   = true;
            var template = null;
            async.whilst(
                function(){return i &lt; paths.length &amp;&amp; doLoop;},
                function(callback) {

                    //attempt to load template
                    TEMPLATE_LOADER.get(paths[i], function(err, templateData){
                        template = templateData;
                        doLoop   = util.isError(err) || !util.isObject(template);
                        i++;
                        callback();
                    });
                },
                function(err) {
                    cb(err, template);
                }
            );
        });
    };

    /**
     * Loads a template file along with any encountered sub-template files and
     * processes any flags.  The call back provides any error encountered and a
     * second parameter that is the transformed content.
     *
     * @method load
     * @param {string}   templateLocation The relative location of the template file.
     * @param {function} cb               Callback function
     */
    TemplateService.prototype.load = function(templateLocation, cb) {
        var self = this;
        this.getTemplateContentsByPriority(templateLocation, function(err, templateContents) {
            if (util.isError(err)) {
                return cb(err, null);
                return;
            }
            else if (!templateContents) {
                return cb(new Error(&#x27;Failed to find a matching template for location: &#x27;+templateLocation), null);
            }

            self.process(templateContents, cb);
        });
    };

    /**
     * Scans the template for flags.  The callback provides any error and a second
     * parameter that is the populated template with any registered flags replaced.
     *
     * @method process
     * @param {string} content The raw content to be inspected for flags
     * @param {function} cb Callback function
     */
    TemplateService.prototype.process = function(content, cb) {
        if (!util.isObject(content)) {
            cb(new Error(&quot;TemplateService: A valid content string is required in order for the template engine to process the value. Content=&quot;+util.inspect(content)), content);
            return;
        }

        //iterate parts
        var self  = this;
        var tasks = util.getTasks(content.parts, function(parts, i) {
            return function(callback) {

                //callback with static content
                var part = parts[i];
                if (part.type === TEMPLATE_PIECE_STATIC) {
                    return callback(null, part.val);
                }
                else if (part.type === TEMPLATE_PIECE_FLAG) {

                    self.processFlag(part.val, function(err, subContent) {
                        if (pb.log.isSilly()) {
                            var str = subContent;
                            if (util.isString(str) &amp;&amp; str.length &gt; 20) {
                                str = str.substring(0, 17)+&#x27;...&#x27;;
                            }
                            pb.log.silly(&quot;TemplateService: Processed flag [%s] Content=[%s]&quot;, part.val, str);
                        }
                        callback(err, subContent);
                    });
                }
                else {
                    pb.log.error(&#x27;An invalid template part type was provided: %s&#x27;, part.type);
                    callback(new Error(&#x27;An invalid template part type was provided: &#x27;+part.type));
                }
            };
        });
        async.series(tasks, function(err, results) {
            cb(err, util.isArray(results) ? results.join(&#x27;&#x27;) : &#x27;&#x27;);
        });
    };

    /**
     * Called when a flag is encountered by the processing engine.  The function is
     * responsible for delegating out the responsibility of the flag to the
     * registered entity.  Some flags are handled by default (although they can
     * always be overriden locally or globally).  The following flags are considered
     * &quot;baked in&quot; and will be handled automatically unless overriden:
     * &lt;ul&gt;
     * &lt;li&gt;^loc_xyz^ - A localization flag.  When provided, the Localization
     * instance will have its &quot;get&quot; function called in an attempt to retrieve the
     * properly translated value for the key (the part betwee &quot;^loc_&quot; and the ending
     * &quot;^&quot;).
     * &lt;/li&gt;
     * &lt;li&gt;^tmp_somedir=someotherdir=templatefileminusext^ - Specifies a
     * sub-template that should be loaded processed.  The file is expected to have
     * a .html extension.
     * &lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @method processFlag
     * @param {string} flag The flag to be processed. The value should NOT contain
     * the carrot (^) prefix or postfix.
     * @param {function} cb Callback function
     */
    TemplateService.prototype.processFlag = function(flag, cb) {
        var self = this;

        //check local
        var doFlagProcessing = function(flag, cb) {
            var tmp;
            if ((tmp = self.localCallbacks[flag]) !== undefined) {//local callbacks
                self.handleReplacement(flag, tmp, cb);
                return;
            }
            else if ((tmp = GLOBAL_CALLBACKS[flag]) !== undefined) {//global callbacks
                self.handleReplacement(flag, tmp, cb);
                return;
            }
            else if (flag.indexOf(LOCALIZATION_PREFIX) == 0 &amp;&amp; self.localizationService) {//localization
                cb(null, self.localizationService.get(flag.substring(LOCALIZATION_PREFIX_LEN)));
                return;
            }
            else if (flag.indexOf(TEMPLATE_PREFIX) == 0) {//sub-templates
                self.handleTemplateReplacement(flag, function(err, template) {
                    cb(null, template);
                });
                return;
            }
            else {

                //log result
                if (pb.log.isSilly()) {
                    pb.log.silly(&quot;TemplateService: Failed to process flag [%s]&quot;, flag);
                }

                //the flag was not registered.  Hand it off to a handler for any 
                //catch-all processing.
                if (util.isFunction(self.unregisteredFlagHandler)) {
                    self.unregisteredFlagHandler(flag, cb);
                }
                else {
                    TemplateService.unregisteredFlagHandler(flag, cb);
                }
            }
        };
        doFlagProcessing(flag, cb);
    };

    /**
     * When a sub-template flag is encountered by the processing engine this
     * function is called to parse the flag and delegate out the loading and
     * processing of the sub-template.
     *
     * @method handleTemplateReplacement
     * @param {string} flag The sub-template flag
     * @param {function} cb Callback function
     */
    TemplateService.prototype.handleTemplateReplacement = function(flag, cb) {
        var pattern      = flag.substring(TEMPLATE_PREFIX_LEN);
        var templatePath = pattern.replace(/=/g, path.sep);

        if (pb.log.isSilly()) {
            pb.log.silly(&quot;Template Serice: Loading Sub-Template. FLAG=[%s] Path=[%s]&quot;, flag, templatePath);
        }
        this.load(templatePath, function(err, template) {
            cb(err, template);
        });
    };

    /**
     * Called when the processing engine encounters a non-sub-template flag.  The
     * function delegates the content transformation out to either the locally or
     * globally registered function.  In the event that a value was registered and not
     * a function then the value is used as the second parameter in the callback.
     * During template re-assembly the value will be converted to a string.
     *
     * @method handleReplacement
     * @param {string} flag The flag to transform
     * @param {mixed} replacement The value can either be a function to handle the
     * replacement or a value.
     * @param {function} cb Callback function
     */
    TemplateService.prototype.handleReplacement = function(flag, replacement, cb) {
        var self    = this;
        var handler = function(err, content) {

            //check for special condition
            if (content instanceof TemplateValue) {
                content = content.val();
            }
            else if (util.isObject(content) || util.isString(content)){;
                content = HtmlEncoder.htmlEncode(content.toString());
            }

            //prevent infinite loops
            if (!self.reprocess || TemplateService.isFlag(content, flag)) {
                cb(err, content);
            }
            else {
                content = {
                    parts: TemplateService.compile(content)
                };
                self.process(content, cb);
            }
        };

        //do replacement
        if (typeof replacement === &#x27;function&#x27;) {
            replacement(flag, handler);
        }
        else {
            handler(null, replacement);
        }
    };

    /**
     * Registers a value or function for the specified
     *
     * @method registerLocal
     * @param {string} flag The flag name to map to the value when encountered in a
     * template.
     * @param {mixed} callbackFunctionOrValue The function to execute to perform the
     * transformation or the value to substitute in place of the flag.
     * @return {Boolean} TRUE when registered successfully, FALSE if not
     */
    TemplateService.prototype.registerLocal = function(flag, callbackFunctionOrValue) {
        this.localCallbacks[flag] = callbackFunctionOrValue;
        return true;
    };

    /**
     * Retrieves the content template names and locations for the active theme.
     *
     * @method getTemplatesForActiveTheme
     * @param {function} cb A call back that provides two parameters: cb(err, [{templateName: templateLocation])
     */
    TemplateService.prototype.getTemplatesForActiveTheme = function(cb) {
        var self = this;
        
        pb.settings.get(&#x27;active_theme&#x27;, function(err, activeTheme) {
            if(util.isError(err) || activeTheme == null) {
                cb(err, []);
                return;
            }

            //function to retrieve plugin
            var getPlugin = function(uid, callback) {
                if (uid === &#x27;pencilblue&#x27;) {

                    //load pencilblue plugin
                    var file = pb.PluginService.getDetailsPath(&#x27;pencilblue&#x27;);
                    pb.PluginService.loadDetailsFile(file, function(err, pb) {
                        if (pb) {
                            pb.dirName = &#x27;pencilblue&#x27;;
                        }
                        callback(err, pb);
                    });
                }
                else {
                    //load normal plugin
                    self.pluginService.getPlugin(activeTheme, callback);
                }
            };

            //do plugin retrieval
            getPlugin(activeTheme, function(err, plugin) {

                var templates = [];
                if (plugin &amp;&amp; plugin.theme &amp;&amp; plugin.theme.content_templates) {

                    for (var j = 0; j &lt; plugin.theme.content_templates.length; j++) {

                        var template = plugin.theme.content_templates[j];
                        templates.push(template);
                    }
                }
                cb(err, templates);
            });
        });
    };

    TemplateService.isFlag = function(content, flag) {
        return util.isString(content) &amp;&amp; (content.length === 0 || (&#x27;^&#x27;+flag+&#x27;^&#x27;) === content);
    };

    /**
     * Retrieves the content templates that are available for use to render
     * Articles and pages.
     *
     * @method getAvailableContentTemplates
     * @return {Array} An array of template definitions
     */
    TemplateService.getAvailableContentTemplates = function() {
        var templates = pb.PluginService.getActiveContentTemplates();
        templates.push(
            {
                theme_uid: &#x27;pencilblue&#x27;,
                theme_name: &#x27;PencilBlue&#x27;,
                name: &quot;Default&quot;,
                file: &quot;index&quot;
            }
        );
        return templates;
    };

    /**
     * Registers a value or function for the specified
     *
     * @static
     * @method registerGlobal
     * @param {string} flag The flag name to map to the value when encountered in a
     * template.
     * @param {mixed} callbackFunctionOrValue The function to execute to perform the
     * transformation or the value to substitute in place of the flag.
     * @return {Boolean} TRUE when registered successfully, FALSE if not
     */
    TemplateService.registerGlobal = function(key, callbackFunctionOrValue) {
        GLOBAL_CALLBACKS[key] = callbackFunctionOrValue;
        return true;
    };

    /**
     * Retrieves the default path to a template file based on the assumption that
     * the provided path is relative to the pencilblue/plugins/pencilblue/templates/ directory.
     *
     * @static
     * @method getDefaultPath
     * @param {string} templateLocation
     * @return {string} The absolute path
     */
    TemplateService.getDefaultPath = function(templateLocation){
        return path.join(pb.config.docRoot, &#x27;plugins&#x27;, &#x27;pencilblue&#x27;, &#x27;templates&#x27;, templateLocation + &#x27;.html&#x27;);
    };

    /**
     * Retrieves the path to a template file based on the assumption that
     * the provided path is relative to the pencilblue/plugins/[themeName]/templates/ directory.
     *
     * @static
     * @method getCustomPath
     * @param {string} templateLocation
     * @return {string} The absolute path
     */
    TemplateService.getCustomPath = function(themeName, templateLocation){
        return path.join(pb.config.docRoot, &#x27;plugins&#x27;, themeName, &#x27;templates&#x27;, templateLocation + &#x27;.html&#x27;);
    };

    /**
     * Compiles the content be eagerly searching for flags/directives.  The static
     * content is also placed into an object.  Whether static or a flag, an object
     * is created and pushed into an array.  Each object has two properties: &quot;type&quot;
     * that describes the type of template part it is (static, flag).  &quot;val&quot; the
     * string value of the part.
     * @static
     * @method compile
     * @param {String} text The template text to compile
     * @param {String} [start=&#x27;^&#x27;] The starting flag marker
     * @param {String} [end=&#x27;^&#x27;] The ending flag marker
     * @return {Array} The array template parts
     */
    TemplateService.compile = function(text, start, end) {
        if (!pb.validation.validateNonEmptyStr(text, true)) {
            pb.log.warn(&#x27;TemplateService: Cannot parse the content because it is not a valid string: &#x27;+text);
            return [];
        }
        if (!pb.validation.validateNonEmptyStr(start, true)) {
            start = &#x27;^&#x27;;
        }
        if (!pb.validation.validateNonEmptyStr(end, true)) {
            end = &#x27;^&#x27;;
        }

        //generates the proper part form
        var genPiece = function(type, val) {
            return {
                type: type,
                val: val
            };
        };

        var i;
        var pipe      = 0;
        var flag      = null;
        var static    = null;
        var flagFound = 0;
        var compiled  = [];
        while ( (i = text.indexOf(start)) &gt;= 0) {

            var start_pos = i + start.length;
            var end_pos   = text.indexOf(end, start_pos);
            if (end_pos &gt;= 0) {

                //determine precursing static content &amp; flag
                flag   = text.substring(start_pos, end_pos);
                static = text.substring(0, start_pos - start.length);

                //add the static content
                if (static) {
                    compiled.push(genPiece(TEMPLATE_PIECE_STATIC, static));
                }

                //add the flag
                if (flag) {
                    compiled.push(genPiece(TEMPLATE_PIECE_FLAG, flag));
                }

                //cut the text down to after the current flag
                text = text.substring(end_pos + end.length);
                if (!text) {
                    break;
                }
            }
            else {
                break;
            }
        }

        //add what&#x27;s left
        if (text) {
            compiled.push(genPiece(TEMPLATE_PIECE_STATIC, text));
        }
        return compiled;
    };

    /**
     * A value that has special meaning to TemplateService.  It acts as a wrapper
     * for a value to be used in a template along with special processing
     * instructions.
     * @class TemplateValue
     * @constructor
     * @param {String} The raw value to be included in the template processing
     * @param {Boolean} [htmlEncode=true] Indicates if the value should be
     * encoded during serialization.
     */
    function TemplateValue(val, htmlEncode){

        this.raw        = val;
        this.htmlEncode = util.isBoolean(htmlEncode) ? htmlEncode : true;
    };

    /**
     * Encodes the value for an HTML document when a value is provided.
     * @method encode
     * @param {Boolean} [doHtmlEncoding] Sets the property to encode the value to HTML
     * @return {Boolean} The current value of the htmlEncode property
     */
    TemplateValue.prototype.encode = function(doHtmlEncoding) {
        if (doHtmlEncoding == true || doHtmlEncoding == false) {
            this.htmlEncode = doHtmlEncoding;
        }
        return this.htmlEncode;
    };

    /**
     * Specifies that the value should not be encoded for HTML
     * @method skipEncode
     */
    TemplateValue.prototype.skipEncode = function() {
        this.encode(false);
    };

    /**
     * Specifies that the value should be encoded for HTML
     * @method doEncode
     */
    TemplateValue.prototype.doEncode = function() {
        this.encode(true);
    };

    /**
     * Retrieves the processed value represented by this object.
     * @method val
     * @return {String} The processed value
     */
    TemplateValue.prototype.val = function() {
        var val = this.raw;
        if (this.encode()) {
            val = HtmlEncoder.htmlEncode(this.raw);
        }
        return val;
    };

    /**
     * Overrides the toString function in order to properly serialize the value.
     * @method toString
     * @return {String} A string representation of the value that follows the
     * processing instructions.
     */
    TemplateValue.prototype.toString = function() {
        return this.val();
    };
    
    return {
        TemplateService: TemplateService,
        TemplateValue: TemplateValue
    };
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
