<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>include\dao\dao.js - PencilBlue</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://pencilblue.org/img/pb_logo.png" title="PencilBlue"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.4.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AdminNavigation.html">AdminNavigation</a></li>
                                <li><a href="../classes/AdminSubnavService.html">AdminSubnavService</a></li>
                                <li><a href="../classes/AnalyticsManager.html">AnalyticsManager</a></li>
                                <li><a href="../classes/ApiActionController.html">ApiActionController</a></li>
                                <li><a href="../classes/ArticleRenderer.html">ArticleRenderer</a></li>
                                <li><a href="../classes/ArticleService.html">ArticleService</a></li>
                                <li><a href="../classes/ArticleServiceV2.html">ArticleServiceV2</a></li>
                                <li><a href="../classes/AsyncJobRunner.html">AsyncJobRunner</a></li>
                                <li><a href="../classes/BaseApiController.html">BaseApiController</a></li>
                                <li><a href="../classes/BaseBodyParser.html">BaseBodyParser</a></li>
                                <li><a href="../classes/BaseController.html">BaseController</a></li>
                                <li><a href="../classes/BaseMediaRenderer.html">BaseMediaRenderer</a></li>
                                <li><a href="../classes/BaseObjectService.html">BaseObjectService</a></li>
                                <li><a href="../classes/CacheEntityService.html">CacheEntityService</a></li>
                                <li><a href="../classes/CacheFactory.html">CacheFactory</a></li>
                                <li><a href="../classes/CacheLockProvider.html">CacheLockProvider</a></li>
                                <li><a href="../classes/CallHomeService.html">CallHomeService</a></li>
                                <li><a href="../classes/ClientJs.html">ClientJs</a></li>
                                <li><a href="../classes/ClusterJobRunner.html">ClusterJobRunner</a></li>
                                <li><a href="../classes/CommandService.html">CommandService</a></li>
                                <li><a href="../classes/CommentService.html">CommentService</a></li>
                                <li><a href="../classes/Configuration.html">Configuration</a></li>
                                <li><a href="../classes/ContentObjectService.html">ContentObjectService</a></li>
                                <li><a href="../classes/ContentService.html">ContentService</a></li>
                                <li><a href="../classes/ContentViewLoader.html">ContentViewLoader</a></li>
                                <li><a href="../classes/CustomObjectService.html">CustomObjectService</a></li>
                                <li><a href="../classes/DailyMotionMediaRenderer.html">DailyMotionMediaRenderer</a></li>
                                <li><a href="../classes/DAO.html">DAO</a></li>
                                <li><a href="../classes/DbEntityService.html">DbEntityService</a></li>
                                <li><a href="../classes/DbLockProvider.html">DbLockProvider</a></li>
                                <li><a href="../classes/DBManager.html">DBManager</a></li>
                                <li><a href="../classes/DeleteController.html">DeleteController</a></li>
                                <li><a href="../classes/DocumentCreator.html">DocumentCreator</a></li>
                                <li><a href="../classes/EmailService.html">EmailService</a></li>
                                <li><a href="../classes/ErrorFormatters.html">ErrorFormatters</a></li>
                                <li><a href="../classes/ErrorsOverTime.html">ErrorsOverTime</a></li>
                                <li><a href="../classes/FormAuthentication.html">FormAuthentication</a></li>
                                <li><a href="../classes/FormBodyParser.html">FormBodyParser</a></li>
                                <li><a href="../classes/FormController.html">FormController</a></li>
                                <li><a href="../classes/FSEntityService.html">FSEntityService</a></li>
                                <li><a href="../classes/FsMediaProvider.html">FsMediaProvider</a></li>
                                <li><a href="../classes/ImageMediaRenderer.html">ImageMediaRenderer</a></li>
                                <li><a href="../classes/InstagramMediaRenderer.html">InstagramMediaRenderer</a></li>
                                <li><a href="../classes/JobRunner.html">JobRunner</a></li>
                                <li><a href="../classes/JobService.html">JobService</a></li>
                                <li><a href="../classes/JsonBodyParser.html">JsonBodyParser</a></li>
                                <li><a href="../classes/JSONFSEntityService.html">JSONFSEntityService</a></li>
                                <li><a href="../classes/KickStarterMediaRenderer.html">KickStarterMediaRenderer</a></li>
                                <li><a href="../classes/LibrariesService.html">LibrariesService</a></li>
                                <li><a href="../classes/Localization.html">Localization</a></li>
                                <li><a href="../classes/LockService.html">LockService</a></li>
                                <li><a href="../classes/MediaLoader.html">MediaLoader</a></li>
                                <li><a href="../classes/MediaService.html">MediaService</a></li>
                                <li><a href="../classes/MemoryEntityService.html">MemoryEntityService</a></li>
                                <li><a href="../classes/MongoCommandBroker.html">MongoCommandBroker</a></li>
                                <li><a href="../classes/MongoMediaProvider.html">MongoMediaProvider</a></li>
                                <li><a href="../classes/MongoRegistrationProvider.html">MongoRegistrationProvider</a></li>
                                <li><a href="../classes/MongoSessionStore.html">MongoSessionStore</a></li>
                                <li><a href="../classes/PageRenderer.html">PageRenderer</a></li>
                                <li><a href="../classes/PageService.html">PageService</a></li>
                                <li><a href="../classes/PB.html">PB</a></li>
                                <li><a href="../classes/PBError.html">PBError</a></li>
                                <li><a href="../classes/PencilBlue.html">PencilBlue</a></li>
                                <li><a href="../classes/PluginService.html">PluginService</a></li>
                                <li><a href="../classes/ReadOnlySimpleLayeredService.html">ReadOnlySimpleLayeredService</a></li>
                                <li><a href="../classes/RedisCommandBroker.html">RedisCommandBroker</a></li>
                                <li><a href="../classes/RedisRegistrationProvider.html">RedisRegistrationProvider</a></li>
                                <li><a href="../classes/RedisSessionStore.html">RedisSessionStore</a></li>
                                <li><a href="../classes/RequestHandler.html">RequestHandler</a></li>
                                <li><a href="../classes/SectionService.html">SectionService</a></li>
                                <li><a href="../classes/SecurityService.html">SecurityService</a></li>
                                <li><a href="../classes/ServerRegistration.html">ServerRegistration</a></li>
                                <li><a href="../classes/SessionHandler.html">SessionHandler</a></li>
                                <li><a href="../classes/SettingsServiceFactory.html">SettingsServiceFactory</a></li>
                                <li><a href="../classes/SimpleLayeredService.html">SimpleLayeredService</a></li>
                                <li><a href="../classes/SlideShareMediaRenderer.html">SlideShareMediaRenderer</a></li>
                                <li><a href="../classes/StorifyMediaRenderer.html">StorifyMediaRenderer</a></li>
                                <li><a href="../classes/System.html">System</a></li>
                                <li><a href="../classes/TemplateEntityService.html">TemplateEntityService</a></li>
                                <li><a href="../classes/TemplateService.html">TemplateService</a></li>
                                <li><a href="../classes/TemplateValue.html">TemplateValue</a></li>
                                <li><a href="../classes/TopicService.html">TopicService</a></li>
                                <li><a href="../classes/TopMenuService.html">TopMenuService</a></li>
                                <li><a href="../classes/TrinketMediaRenderer.html">TrinketMediaRenderer</a></li>
                                <li><a href="../classes/TTLIndexHelper.html">TTLIndexHelper</a></li>
                                <li><a href="../classes/UrlService.html">UrlService</a></li>
                                <li><a href="../classes/UsernamePasswordAuthentication.html">UsernamePasswordAuthentication</a></li>
                                <li><a href="../classes/UserService.html">UserService</a></li>
                                <li><a href="../classes/Util.html">Util</a></li>
                                <li><a href="../classes/ValidationService.html">ValidationService</a></li>
                                <li><a href="../classes/VideoMediaRenderer.html">VideoMediaRenderer</a></li>
                                <li><a href="../classes/View Controller.html">View Controller</a></li>
                                <li><a href="../classes/VimeoMediaRenderer.html">VimeoMediaRenderer</a></li>
                                <li><a href="../classes/VineMediaRenderer.html">VineMediaRenderer</a></li>
                                <li><a href="../classes/YouTubeMediaRenderer.html">YouTubeMediaRenderer</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Admin.html">Admin</a></li>
                                <li><a href="../modules/dao.html">dao</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Entities.html">Entities</a></li>
                                <li><a href="../modules/ErrorSuccess.html">ErrorSuccess</a></li>
                                <li><a href="../modules/Model.html">Model</a></li>
                                <li><a href="../modules/Security.html">Security</a></li>
                                <li><a href="../modules/Services.html">Services</a></li>
                                <li><a href="../modules/Session.html">Session</a></li>
                                <li><a href="../modules/Storage.html">Storage</a></li>
                                <li><a href="../modules/Theme.html">Theme</a></li>
                                <li><a href="../modules/Validation.html">Validation</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: include\dao\dao.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Copyright (C) 2015  PencilBlue, LLC

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/

//dependencies
var ObjectID = require(&#x27;mongodb&#x27;).ObjectID;
var util     = require(&#x27;../util.js&#x27;);

module.exports = function DAOModule(pb) {

    /**
     * Controlls the data model
     *
     * @module Database
     * @class DAO
     * @constructor
     * @param {String} [dbName] Will default to the config.db.name DB when not
     * provided.
     * @main Database
     */
    function DAO(dbName){

        /**
         * The name of the DB that this instance is intended to interact with.  By
         * default, it goes to the name of the DB provided by system configuration
         * property db.name.
         * @property dbName
         * @type {String}
         */
        this.dbName = util.isNullOrUndefined(dbName) ? pb.config.db.name : dbName;
    }

    /**
     * Static variable to indicate that all indices of a document should be
     * retrieved
     *
     * @property PROJECT_ALL
     * @type {Object}
     */
    DAO.PROJECT_ALL = Object.freeze({});

    /**
     * Static variable to indicate that documents should be retrieve from anywhere
     *
     * @property ANYWHERE
     * @type {Object}
     */
    DAO.ANYWHERE = Object.freeze({});

    /**
     * Static variable to indicate that documents should be returned in their
     * natural order
     *
     * @property NATURAL_ORDER
     * @type {Array}
     */
    DAO.NATURAL_ORDER = Object.freeze([]);

    /**
     * Static varible to sort ascending
     *
     * @property ASC
     * @type {Number}
     */
    DAO.ASC = 1;

    /**
     * Static variable to sort descending
     *
     * @property DESC
     * @type {Number}
     */
    DAO.DESC = -1;

    /**
     * Retrieves an object by ID
     *
     * @method loadById
     * @param {String}   id         The unique id of the object
     * @param {String}   collection The collection the object is in
     * @param {Object}   Key value pair object to exclude the retrival of data
     * @param {Function} cb         Callback function
     */
    DAO.prototype.loadById = function(id, collection, opts, cb){
        this.loadByValues(DAO.getIdWhere(id), collection, opts, cb);
    };

    /**
     * Retrieves objects matching a key value pair
     *
     * @method loadByValue
     * @param {String}   key        The key to search for
     * @param {*}        val        The value to search for
     * @param {String}   collection The collection to search in
     * @param {Object}   opts Key value pair object to exclude the retrival of data
     * @param {Function} cb         Callback function
     */
    DAO.prototype.loadByValue = function(key, val, collection, opts, cb) {
        var where = {};
        where[key] = val;
        this.loadByValues(where, collection, opts, cb);
    };

    /**
     * Retrieves object matching several key value pairs
     *
     * @method loadByValues
     * @param {Object}   where      Key value pair object
     * @param {String}   collection The collection to search in
     * @param {Object}   opts Key value pair object to exclude the retrival of data
     * @param {Function} cb         Callback function
     */
    DAO.prototype.loadByValues = function(where, collection, opts, cb) {
        if (util.isFunction(opts)) {
            cb = opts;
            opts = null;
        }
        if (!util.isObject(opts)) {
            opts = { };
        }

        var options = {
            where: where,
            select: opts.select || DAO.PROJECT_ALL,
            order: opts.order || DAO.NATURAL_ORDER,
            limit: 1
        };
        this.q(collection, options, function(err, result){
           cb(err, util.isArray(result) &amp;&amp; result.length &gt; 0 ? result[0] : null);
        });
    };

    /**
     * Gets the count of objects matching criteria
     *
     * @method count
     * @param  {String}   entityType The type of object to search for
     * @param  {Object}   where      Key value pair object
     * @param  {Function} cb         Callback function
     */
    DAO.prototype.count = function(entityType, where, cb) {
        var options = {
            count: true,
            entityType: entityType,
            where: where
        };
        this._doQuery(options, function(err, cursor) {
            if (util.isError(err)) {
                return cb(err);
            }
            cursor.count(cb);
        });
    };

    /**
     * Determines if an object extists matching criteria
     *
     * @method exists
     * @param  {String}   collection The collection to search in
     * @param  {Object}   where      Key value pair object
     * @param  {Function} cb         Callback function
     */
    DAO.prototype.exists = function(collection, where, cb) {
        this.count(collection, where, function(err, count) {
            cb(err, count &gt; 0);
        });
    };

    /**
     * Determines if there is only a single document that matches the specified query
     *
     * @method unique
     * @param  {String}   collection    The collection to search in
     * @param  {Object}   where         Key value pair object
     * @param  {String}   [exclusionId] Object Id to exclude from the search
     * @param  {Function} cb            Callback function
     */
    DAO.prototype.unique = function(collection, where, exclusionId, cb) {
        if (util.isFunction(exclusionId)) {
            cb          = exclusionId;
            exclusionId = null;
        }

        //validate parameters
        if (!util.isObject(where) || !util.isString(collection)) {
            return cb(new Error(&quot;The collection and where parameters are required&quot;));
        }

        //set the exclusion
        if (exclusionId) {
            where[DAO.getIdField()] = DAO.getNotIDField(exclusionId);
        }

        //checks to see how many docs were available
        this.count(collection, where, function(err, count) {
            cb(err, count === 0);
        });
    };

    /**
     * Queries the database. Added in the 0.2.5 release
     * @method q
     * @param  {String} collection The type of object to search for
     * @param  {Object} [options] The options for the query
     * @param {Object} [options.where={}] The conditions under which results are
     * returned
     * @param  {Object} [options.select] Selection type object
     * @param  {Array} [options.order]  Order by array (MongoDB syntax)
     * @param  {Integer} [options.limit] Number of documents to retrieve
     * @param  {Integer} [options.offset] Start index of retrieval
     * @param {Function} [options.handler] A function that takes two paramters.
     * The first, the Cursor object that contains the results of the query.  The
     * second is a callback that takes two parameters.  An error if occurred and by
     * default, the documents returned by the query.  Custom handlers may provide
     * whatever value it wishes including the cursor if it wishes to handle the
     * results itself.
     * @param {Function} cb A callback function that takes two parameters.  The
     * first, an error, if occurred and the second is the result provided by the
     * handler.  By default it provides an array of objects that represent the
     * items returned by the query.
     */
    DAO.prototype.q = function(collection, options, cb) {
        if (util.isFunction(options)) {
            cb      = options;
            options = {};
        }
        else if (!util.isObject(options)) {
            return cb(new Error(&#x27;OPTIONS_PARAM_MUST_BE_OBJECT&#x27;));
        }

        //execute the query
        var self = this;
        var opts = {
            entityType: collection,
            where: options.where,
            select: options.select,
            order: options.order,
            limit: options.limit,
            offset: options.offset
        };
        this._doQuery(opts, function(err, cursor) {
            if (util.isError(err)) {
                return cb(err);
            }

            //handle cursor
            var handler = util.isFunction(options.handler) ? options.handler : self.toArrayCursorHandler;
            handler(cursor, function(err, docs) {

                //close the cursor
                cursor.close(function(err){
                    if (util.isError(err)) {
                        pb.log.error(&quot;DAO: An error occurred while attempting to close the cursor. %s&quot;, err.stack);
                    }
                });

                //callback with results
                cb(err, docs);
            });
        });
    };

    /**
     * A cursor handler that iterates over each result from the query that created
     * the cursor and places the result into an array.  The array of documents is
     * provided as the second argument in the callback.
     * @method toArrayCursorHandler
     * @param {Cursor} cursor
     * @param {Function} cb
     */
    DAO.prototype.toArrayCursorHandler = function(cursor, cb) {
        cursor.toArray(cb);
    };

    /**
     * The actual implementation for querying.  The function does not do the same
     * type checking as the wrapper function &quot;query&quot;.  This funciton is responsible
     * for doing the heavy lifting and returning the result back to the calling intity.
     * @protected
     * @method _doQuery
     * @param {String} entityType The collection to query
     * @param {Object} [where={}] The where clause
     * @param {Object} [select={}] The fields to project
     * @param {Array} [order] The ordering
     * @param {Array} [orderBy] The ordering. Parameter orderBy is deprecated, use order instead.
     * @param {Integer} [limit] The maximum number of results to return
     * @param {Integer} [offset] The number of results to skip before returning results.
     * @return {Cursor} The MongoDB cursor that provides the results of the query
     */
    DAO.prototype._doQuery = function(options, cb) {
        if (!util.isString(options.entityType)) {
            return cb(Error(&#x27;An entity type must be specified!&#x27;));
        }

        //set defaults
        var entityType = options.entityType;
        var where      = options.where  ? options.where : DAO.ANYWHERE;
        var select     = options.select ? options.select : DAO.PROJECT_ALL;
        var offset     = options.offset ? options.offset : 0;

        //get reference to the db
        var self = this;
        this.getDb(function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }

            //assemble the query
            var cursor = db.collection(options.entityType)
                .find(where, select)
                .skip(offset);

            //apply sort order
            var orderBy = options.order || options.orderBy;
            if (orderBy) {
                cursor.sort(orderBy);
            }

            //apply maximum number of results to return
            if (options.limit) {
                cursor.limit(options.limit);
            }

            //log the result
            if(pb.config.db.query_logging){
                var query = &quot;DAO: %s %j FROM %s.%s WHERE %j&quot;;
                var args = [options.count ? &#x27;COUNT&#x27; : &#x27;SELECT&#x27;, select, self.dbName, entityType, where];
                if (typeof orderBy !== &#x27;undefined&#x27;) {
                    query += &quot; ORDER BY %j&quot;;
                    args.push(orderBy);
                }
                if (typeof options.limit !== &#x27;undefined&#x27;) {
                    query += &quot; LIMIT %d, OFFSET %d&quot;;
                    args.push(options.limit, offset);
                }
                args.unshift(query);
                pb.log.info(util.format.apply(util, args));
            }
            cb(null, cursor);
        });
    };

    /**
     * Retrieves a refernce to the DB with active connection
     * @method getDb
     * @param {Function} cb
     */
    DAO.prototype.getDb = function(cb) {
        pb.dbm.getDb(this.dbName, cb);
    };

    /**
     * Inserts or replaces an existing document with the specified DB Object. 
     * An insert is distinguished from an update based the presence of the _id 
     * field.
     * @method save
     * @param {Object} dbObj The system object to persist
     * @param {Object} [options] See http://mongodb.github.io/node-mongodb-native/api-generated/collection.html#save
     * @param {Function} cb A callback that takes two parameters.  The first, an
     * error, if occurred.  The second is the object that was persisted
     */
    DAO.prototype.save = function(dbObj, options, cb) {
        if (util.isFunction(options)) {
            cb      = options;
            options = {};
        }
        else if (!util.isObject(options)) {
            return cb(new Error(&#x27;OPTIONS_PARAM_MUST_BE_OBJECT&#x27;));
        }
        if (!util.isObject(dbObj)) {
            return cb(new Error(&#x27;The dbObj parameter must be an object&#x27;));
        }

        //ensure an object_type was specified &amp; update common fields
        dbObj.object_type = dbObj.object_type || options.object_type;
        DAO.updateChangeHistory(dbObj);
        
        //log interaction
        if (pb.config.db.query_logging) {
            var msg;
            if (dbObj._id) {
                msg = util.format(&#x27;UPDATE %s WHERE ID=%s&#x27;, dbObj.object_type, dbObj._id);
            }
            else {
                msg = util.format(&#x27;INSERT INTO %s&#x27;, dbObj.object_type);
            }
            pb.log.info(msg);
        }

        //retrieve db reference
        this.getDb(function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }

            //execute persistence operation
            db.collection(dbObj.object_type).save(dbObj, options, function(err/*, writeOpResult*/) {
                cb(err, dbObj);
            });
        });
    };

    /**
     * Provides a mechanism to save an array of objects all from the same
     * collection.  The function handles updates and inserts.  The difference is
     * determined by the truth value of the ID field of each object.
     * @method saveBatch
     * @param {Array} objArray The array of objects to persist
     * @param {String} collection The collection to persist the objects to
     * @param {Object} [options] See http://mongodb.github.io/node-mongodb-native/api-generated/collection.html#initializeunorderedbulkop
     * @param {Function} cb A callback that takes two arguments.  The first is an
     * error, if occurred. The second is the second parameter of the callback
     * described here: http://mongodb.github.io/node-mongodb-native/api-generated/unordered.html#execute
     */
    DAO.prototype.saveBatch = function(objArray, collection, options, cb) {
        if (util.isFunction(options)) {
            cb      = options;
            options = {
                useLegacyOps: true
            };
        }
        else if (!util.isObject(options)) {
            return cb(new Error(&#x27;OPTIONS_PARAM_MUST_BE_OBJECT&#x27;));
        }
        if (!util.isArray(objArray)) {
            return cb(new Error(&#x27;The objArray parameter must be an Array&#x27;));
        }
        else if (!util.isString(collection)) {
            return cb(new Error(&#x27;COLLECTION_MUST_BE_STR&#x27;));
        }

        //retrieve db reference
        this.getDb(function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }

            //initialize the batch operation
            var col = db.collection(collection);
            var batch = col.initializeUnorderedBulkOp(options);

            //build the batch
            objArray.forEach(function(item) {

                item.object_type = collection;
                DAO.updateChangeHistory(item);
                if (item[DAO.getIdField()]) {
                    batch.update(item);
                }
                else {
                    batch.insert(item);
                }
            });
            batch.execute(cb);
        });
    };

    /**
     * Updates a specific set of fields. This is handy for performing upserts.
     * @method updateFields
     * @param {String} collection The collection to update object(s) in
     * @param {Object} query The where clause to execute to find the existing object
     * @param {Object} updates The updates to perform
     * @param {Object} options Any options to go along with the update
     * @param {Boolean} [options.upsert=false] Inserts the object is not found
     * @param {Boolean} [options.multi=false] Updates multiple records if the query
     * finds more than 1
     * @param {Function} cb
     */
    DAO.prototype.updateFields = function(collection, query, updates, options, cb) {
        if (util.isFunction(options)) {
            cb = options;
            options = {};
        }

        if (pb.config.db.query_logging) {
            pb.log.info(&#x27;UPDATE %s.%s %s WHERE %s WITH OPTIONS %s&#x27;, this.dbName, collection, JSON.stringify(updates), JSON.stringify(query), JSON.stringify(options));
        }
        this.getDb(function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }

            //execute update
            db.collection(collection).update(query, updates, options, cb);
        });
    };

    /**
     * Removes an object from persistence
     *
     * @method deleteById
     * @param {String|ObjectID} oid The Id of the object to remove
     * @param {String} collection The collection the object is in
     * @param {Function} [cb] A callback that takes two parameters.  The first is
     * an error, if occurred.  The second is the number of records deleted by the
     * execution of the command.
     * @return {Promise} Promise object iff a callback is not provided
     */
    DAO.prototype.deleteById = function(oid, collection, cb) {
        if (!pb.validation.isId(oid)) {
            return cb(new Error(&#x27;An id must be specified in order to delete&#x27;));
        }

        var where = DAO.getIdWhere(oid);
        this.delete(where, collection, cb);
    };

    /**
     * Removes objects from persistence that match criteria
     *
     * @method delete
     * @param {Object} where Key value pair object
     * @param {String} collection The collection to search in
     * @param {Object} [options] See http://mongodb.github.io/node-mongodb-native/api-generated/collection.html#remove
     * @param {Function} cb A callback that provides two parameter. The first is an
     * error, if occurred.  The second is the number of records that were removed
     * from persistence.
     */
    DAO.prototype.delete = function(where, collection, options, cb) {
        if (util.isFunction(options)) {
            cb = options;
            options = {};
        }
        else if (!util.isObject(options)) {
            return cb(new Error(&#x27;OPTIONS_PARAM_MUST_BE_OBJECT&#x27;));
        }

        //require param error checking
        if (!util.isObject(where)) {
            return cb(new Error(&#x27;WHERE_CLAUSE_MUST_BE_OBJECT&#x27;));
        }
        else if (!util.isString(collection)) {
            return cb(new Error(&#x27;COLLECTION_MUST_BE_STR&#x27;));
        }

        //log interaction
        if(pb.config.db.query_logging){
            pb.log.info(&#x27;DAO: DELETE FROM %s.%s WHERE %s&#x27;, this.dbName, collection, JSON.stringify(where));
        }

        //execute delete command
        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            db.collection(collection).remove(where, options, cb);
        });
    };

    /**
     * Sends a command to the DB.
     * http://mongodb.github.io/node-mongodb-native/api-generated/db.html#command
     * @method command
     * @param {Object} The command to execute
     * @param {Function} cb A callback that provides two parameters: cb(Error, [RESULT])
     */
    DAO.prototype.command = function(command, cb) {
        if (!util.isObject(command)) {
            cb(new Error(&#x27;COMMAND_MUST_BE_OBJECT&#x27;));
            return;
        }

        //execute command
        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            db.command(command, cb);
        });
    };

    /**
     * Attempts to create an index.  If the collection already exists then the
     * operation is skipped.
     * http://mongodb.github.io/node-mongodb-native/api-generated/collection.html#ensureindex
     * @method ensureIndex
     * @param {Object} procedure The objects containing the necessary parameters
     * and options to create the index.
     *  @param {String} procedure.collection The collection to build an index for
     *  @param {Object} procedure.spec An object that specifies one or more fields
     * and sort direction for the index.
     *  @param {Object} [procedure.options={}] An optional parameter that can
     * specify the options for the index.
     * @param {Function} cb A callback that provides two parameters: cb(Error, [RESULT])
     */
    DAO.prototype.ensureIndex = function(procedure, cb) {
        if (!util.isObject(procedure)) {
            cb(new Error(&#x27;PROCEDURE_MUST_BE_OBJECT&#x27;));
            return;
        }

        //extract needed values
        var collection = procedure.collection;
        var spec       = procedure.spec;
        var options    = procedure.options || {};

        //execute command
        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            db.collection(collection).ensureIndex(spec, options, cb);
        });
    };
    
    /**
     * Retrieves indexes for the specified collection
     * @method indexInfo
     * @param {String} collection
     * @param {Object} [options={}]
     * @param {Function} cb
     */
    DAO.prototype.indexInfo = function(collection, options, cb) {
        if (util.isFunction(options)) {
            cb = options;
            options = {};
        }
        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            
            db.indexInformation(collection, options, cb);
        });
    };
    
    /**
     * Drops the specified index from the given collection
     * @method dropIndex
     * @param {String} collection
     * @param {String} indexName
     * @param {Object} [options={}]
     * @param {Function} cb
     */
    DAO.prototype.dropIndex = function(collection, indexName, options, cb) {
        if (util.isFunction(options)) {
            cb = options;
            options = {};
        }
        
        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            db.collection(collection).dropIndex(indexName, options, cb);
        });
    };

    /**
     * Determines if a collection exists in the DB
     * @method entityExists
     * @param {String} entity The name of the collection
     * @param {Function} cb A callback that takes two parameters. The first, an
     * error, if occurred. The second is a boolean where TRUE means the entity
     * exists, FALSE if not.
     */
    DAO.prototype.entityExists = function(entity, cb) {
        var options = {
            namesOnly: true
        };

        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            db.listCollections({name: entity}, options).toArray(function(err, results) {
                cb(err, util.isArray(results) &amp;&amp; results.length === 1);
            });
        });
    };

    /**
     * Creates a collection in the DB
     * @method createEntity
     * @param {String} entityName
     * @param {Object} [options] The options for the collection. See
     * http://mongodb.github.io/node-mongodb-native/api-generated/db.html#createcollection
     * @param {Function} cb A callback that takes two parameters. The first, an
     * Error, if occurred. The second is the result of the creation command.
     */
    DAO.prototype.createEntity = function(entityName, options, cb) {
        if (util.isFunction(options)) {
            cb      = options;
            options = {};
        }
        else if (!util.isObject(options)) {
            return cb(new Error(&#x27;OPTIONS_PARAM_MUST_BE_OBJECT&#x27;));
        }

        pb.dbm.getDb(this.dbName, function(err, db) {
            if (util.isError(err)) {
                return cb(err);
            }
            db.createCollection(entityName, options, cb);
        });
    };

    /**
     * Creates a basic where clause based on the specified Id
     * @deprecated since 0.4.0
     * @static
     * @method getIDWhere
     * @param {String} oid Object Id String
     * @return {Object}    Where clause
     */
    DAO.getIDWhere = function(oid){
        pb.log.warn(&#x27;DAO: getIDWhere is deprecated.  Use getIdWhere instead&#x27;);
        return DAO.getIdWhere(oid);
    };

    /**
     * Creates a basic where clause based on the specified Id
     * @static
     * @method getIdWhere
     * @param {String} oid Object Id String
     * @return {Object} Where clause
     */
    DAO.getIdWhere = function(oid) {
        return {
            _id: DAO.getObjectId(oid)
        };
    };

    /**
     * Creates a where clause that equates to select where [idProp] is in the
     * specified array of values.
     * @static
     * @method getIDInWhere
     * @param {Array} objArray The array of acceptable values
     * @param {String} idProp The property that holds a referenced ID value
     * @return {Object} Where clause
     */
    DAO.getIDInWhere = function(objArray, idProp) {
        pb.log.warn(&#x27;DAO: getIDInWhere is deprecated. Use getIdInWhere instead&#x27;);
        return DAO.getIdInWhere(objArray, idProp);
    };

    /**
     * Creates a where clause that equates to select where [idProp] is in the
     * specified array of values.
     * @static
     * @method getIdInWhere
     * @param {Array} objArray The array of acceptable values
     * @param {String} idProp The property that holds a referenced ID value
     * @return {Object} Where clause
     */
    DAO.getIdInWhere = function(objArray, idProp) {
        var seen = {};
        var idArray = [];
        for(var i = 0; i &lt; objArray.length; i++) {

            var rawId;
            if (idProp) {
                rawId = objArray[i][idProp];
            }
            else{
                rawId = objArray[i];
            }
            if (!seen[rawId]) {
                seen[rawId] = true;
                idArray.push(DAO.getObjectId(rawId));
            }
        }
        return {
            _id: {$in: idArray}
        };
    };

    /**
     * Creates a where clause that equates to select where [idProp] is not in the
     * specified array of values.
     * @static
     * @method getIDInWhere
     * @param {Array} objArray The array of acceptable values
     * @param {String} idProp The property that holds a referenced ID value
     * @return {Object} Where clause
     */
    DAO.getIdNotInWhere = function(objArray, idProp) {
        var idArray = [];
        for(var i = 0; i &lt; objArray.length; i++) {

            var rawId;
            if (idProp) {
                rawId = objArray[i][idProp];
            }
            else{
                rawId = objArray[i];
            }
            idArray.push(DAO.getObjectId(rawId));
        }
        return {
            _id: {$nin: idArray}
        };
    };

    /**
     * Creates a basic where clause based on not equalling the specified Id
     * @deprecated
     * @static
     * @method getNotIDWhere
     * @param {String} oid Object Id String
     * @return {Object}    Where clause
     */
    DAO.getNotIDWhere = function(oid) {
        pb.log.warn(&#x27;DAO: getNotIDField is deprecated. Use getNotIdField instead&#x27;);
        return DAO.getNotIdWhere(oid);
    };

    /**
     * Creates a basic where clause based on not equalling the specified Id
     * @static
     * @method getNotIdWhere
     * @param {String} oid Object Id String
     * @return {Object}    Where clause
     */
    DAO.getNotIdWhere = function(oid) {
        return {
            _id: DAO.getNotIdField(oid)
        };
    };

    /**
     * Creates a where clause that indicates to select where the &#x27;_id&#x27; field does
     * not equal the specified value.
     * @deprecated since 0.4.0
     * @static
     * @method getNotIDField
     * @return {Object} Where clause
     */
    DAO.getNotIDField = function(oid) {
        pb.log.warn(&#x27;DAO: getNotIDField is deprecated. Use getNotIdField instead&#x27;);
        return DAO.getNotIdField(oid);
    };

    /**
     * Creates a where clause that indicates to select where the &#x27;_id&#x27; field does
     * not equal the specified value.
     * @static
     * @method getNotIdField
     * @return {Object} Where clause
     */
    DAO.getNotIdField = function(oid) {
        return {$ne: DAO.getObjectId(oid)};
    };

    /**
     * Creates an MongoDB ObjectID object
     * @deprecated since 0.4.0
     * @static
     * @method getObjectID
     * @param {String} oid Object Id String
     * @return {Object}    ObjectID object
     */
    DAO.getObjectID = function(oid) {
        pb.log.warn(&#x27;DAO: getObjectID is deprecated. Use getObjectId instead&#x27;);
        return DAO.getObjectId(oid);
    };

    /**
     * Creates an MongoDB ObjectID object
     * @static
     * @method getObjectId
     * @param {String} oid Object Id String
     * @return {Object}    ObjectID object
     */
    DAO.getObjectId = function(oid) {
        try {
           return new ObjectID(oid + &#x27;&#x27;);
        }
        catch(err) {
            return oid;
        }
    };

    /**
     * Updates a DB object with a created time stamp and last modified time stamp.
     * @static
     * @method updateChangeHistory
     * @param {Object} dbObject Object to update
     */
    DAO.updateChangeHistory = function(dbObject){
        if (util.isNullOrUndefined(dbObject)) {
            throw new Error(&quot;The dbObject parameter is required&quot;);
        }

        var now = new Date();
        if (util.isNullOrUndefined(dbObject._id)) {
            dbObject.created = now;
        }

        //update for current changes
        dbObject.last_modified = now;
    };

    /**
     * Transfers a system object from one type to another.  The system specific
     * properties are cleared so that when the object is persisted it will receive
     * its own properties.
     * @static
     * @method transfer
     * @param {Object} obj The object to convert
     * @param {String} to The type to convert it to
     */
    DAO.transfer = function(obj, to) {
        if (!util.isObject(obj) || !util.isString(to)) {
            throw new Error(&#x27;OBJ_TO_PARAMS_MUST_BE&#x27;);
        }

        delete obj._id;
        delete obj.created;
        delete obj.last_modified;
        obj.object_type = to;
    };

    /**
     * Retrieves the field in system objects that represents the unique identifier.
     * The default implementation returns the mongo field &#x27;_id&#x27;.
     * @static
     * @method getIdField
     * @return {String} &#x27;_id&#x27;
     */
    DAO.getIdField = function() {
        return &#x27;_id&#x27;;
    };

    /**
     * Determines if two object IDs are equal
     * @static
     * @method areIdsEqual
     * @param {ObjectID|String} id1
     * @param {ObjectID|String} id2
     * @return {Boolean} TRUE if IDs are equal
     */
    DAO.areIdsEqual = function(id1, id2) {
        return id1.toString() === id2.toString();
    };

    //exports
    return DAO;
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
