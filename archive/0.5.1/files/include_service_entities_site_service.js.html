<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>include\service\entities\site_service.js - PencilBlue</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://pencilblue.org/img/pb_logo.png" title="PencilBlue"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.5.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AdminNavigation.html">AdminNavigation</a></li>
                                <li><a href="../classes/AdminSubnavService.html">AdminSubnavService</a></li>
                                <li><a href="../classes/AnalyticsManager.html">AnalyticsManager</a></li>
                                <li><a href="../classes/ApiActionController.html">ApiActionController</a></li>
                                <li><a href="../classes/ArticleRenderer.html">ArticleRenderer</a></li>
                                <li><a href="../classes/ArticleService.html">ArticleService</a></li>
                                <li><a href="../classes/ArticleServiceV2.html">ArticleServiceV2</a></li>
                                <li><a href="../classes/AsyncJobRunner.html">AsyncJobRunner</a></li>
                                <li><a href="../classes/AudioMediaRenderer.html">AudioMediaRenderer</a></li>
                                <li><a href="../classes/BaseAdminController.html">BaseAdminController</a></li>
                                <li><a href="../classes/BaseApiController.html">BaseApiController</a></li>
                                <li><a href="../classes/BaseBodyParser.html">BaseBodyParser</a></li>
                                <li><a href="../classes/BaseController.html">BaseController</a></li>
                                <li><a href="../classes/BaseMediaRenderer.html">BaseMediaRenderer</a></li>
                                <li><a href="../classes/BaseObjectService.html">BaseObjectService</a></li>
                                <li><a href="../classes/CacheEntityService.html">CacheEntityService</a></li>
                                <li><a href="../classes/CacheFactory.html">CacheFactory</a></li>
                                <li><a href="../classes/CacheLockProvider.html">CacheLockProvider</a></li>
                                <li><a href="../classes/CallHomeService.html">CallHomeService</a></li>
                                <li><a href="../classes/ClientJs.html">ClientJs</a></li>
                                <li><a href="../classes/ClusterJobRunner.html">ClusterJobRunner</a></li>
                                <li><a href="../classes/CommandService.html">CommandService</a></li>
                                <li><a href="../classes/CommentService.html">CommentService</a></li>
                                <li><a href="../classes/Configuration.html">Configuration</a></li>
                                <li><a href="../classes/ContentObjectService.html">ContentObjectService</a></li>
                                <li><a href="../classes/ContentService.html">ContentService</a></li>
                                <li><a href="../classes/ContentViewLoader.html">ContentViewLoader</a></li>
                                <li><a href="../classes/CustomObjectService.html">CustomObjectService</a></li>
                                <li><a href="../classes/DailyMotionMediaRenderer.html">DailyMotionMediaRenderer</a></li>
                                <li><a href="../classes/DAO.html">DAO</a></li>
                                <li><a href="../classes/DbEntityService.html">DbEntityService</a></li>
                                <li><a href="../classes/DbLockProvider.html">DbLockProvider</a></li>
                                <li><a href="../classes/DBManager.html">DBManager</a></li>
                                <li><a href="../classes/DBMigrate.html">DBMigrate</a></li>
                                <li><a href="../classes/DeleteController.html">DeleteController</a></li>
                                <li><a href="../classes/DocumentCreator.html">DocumentCreator</a></li>
                                <li><a href="../classes/EmailService.html">EmailService</a></li>
                                <li><a href="../classes/ErrorFormatters.html">ErrorFormatters</a></li>
                                <li><a href="../classes/ErrorsOverTime.html">ErrorsOverTime</a></li>
                                <li><a href="../classes/ErrorViewController.html">ErrorViewController</a></li>
                                <li><a href="../classes/FormAuthentication.html">FormAuthentication</a></li>
                                <li><a href="../classes/FormBodyParser.html">FormBodyParser</a></li>
                                <li><a href="../classes/FormController.html">FormController</a></li>
                                <li><a href="../classes/FSEntityService.html">FSEntityService</a></li>
                                <li><a href="../classes/FsMediaProvider.html">FsMediaProvider</a></li>
                                <li><a href="../classes/ImageMediaRenderer.html">ImageMediaRenderer</a></li>
                                <li><a href="../classes/InstagramMediaRenderer.html">InstagramMediaRenderer</a></li>
                                <li><a href="../classes/JobRunner.html">JobRunner</a></li>
                                <li><a href="../classes/JobService.html">JobService</a></li>
                                <li><a href="../classes/JsonBodyParser.html">JsonBodyParser</a></li>
                                <li><a href="../classes/JSONFSEntityService.html">JSONFSEntityService</a></li>
                                <li><a href="../classes/KickStarterMediaRenderer.html">KickStarterMediaRenderer</a></li>
                                <li><a href="../classes/LibrariesService.html">LibrariesService</a></li>
                                <li><a href="../classes/Localization.html">Localization</a></li>
                                <li><a href="../classes/LockService.html">LockService</a></li>
                                <li><a href="../classes/MediaLoader.html">MediaLoader</a></li>
                                <li><a href="../classes/MediaService.html">MediaService</a></li>
                                <li><a href="../classes/MemoryEntityService.html">MemoryEntityService</a></li>
                                <li><a href="../classes/MongoCommandBroker.html">MongoCommandBroker</a></li>
                                <li><a href="../classes/MongoMediaProvider.html">MongoMediaProvider</a></li>
                                <li><a href="../classes/MongoRegistrationProvider.html">MongoRegistrationProvider</a></li>
                                <li><a href="../classes/MongoSessionStore.html">MongoSessionStore</a></li>
                                <li><a href="../classes/PageRenderer.html">PageRenderer</a></li>
                                <li><a href="../classes/PageService.html">PageService</a></li>
                                <li><a href="../classes/PB.html">PB</a></li>
                                <li><a href="../classes/PBError.html">PBError</a></li>
                                <li><a href="../classes/PdfMediaRenderer.html">PdfMediaRenderer</a></li>
                                <li><a href="../classes/PencilBlue.html">PencilBlue</a></li>
                                <li><a href="../classes/PluginRepository.html">PluginRepository</a></li>
                                <li><a href="../classes/PluginService.html">PluginService</a></li>
                                <li><a href="../classes/PluginSettingService.html">PluginSettingService</a></li>
                                <li><a href="../classes/ReadOnlySimpleLayeredService.html">ReadOnlySimpleLayeredService</a></li>
                                <li><a href="../classes/RedisCommandBroker.html">RedisCommandBroker</a></li>
                                <li><a href="../classes/RedisRegistrationProvider.html">RedisRegistrationProvider</a></li>
                                <li><a href="../classes/RedisSessionStore.html">RedisSessionStore</a></li>
                                <li><a href="../classes/RequestHandler.html">RequestHandler</a></li>
                                <li><a href="../classes/SectionService.html">SectionService</a></li>
                                <li><a href="../classes/SecurityService.html">SecurityService</a></li>
                                <li><a href="../classes/ServerInitializer.html">ServerInitializer</a></li>
                                <li><a href="../classes/ServerRegistration.html">ServerRegistration</a></li>
                                <li><a href="../classes/SessionHandler.html">SessionHandler</a></li>
                                <li><a href="../classes/SettingService.html">SettingService</a></li>
                                <li><a href="../classes/SettingsServiceFactory.html">SettingsServiceFactory</a></li>
                                <li><a href="../classes/SimpleLayeredService.html">SimpleLayeredService</a></li>
                                <li><a href="../classes/SiteActivateJob.html">SiteActivateJob</a></li>
                                <li><a href="../classes/SiteCreateEditJob.html">SiteCreateEditJob</a></li>
                                <li><a href="../classes/SiteDeactivateJob.html">SiteDeactivateJob</a></li>
                                <li><a href="../classes/SiteJobRunner.html">SiteJobRunner</a></li>
                                <li><a href="../classes/SiteMapService.html">SiteMapService</a></li>
                                <li><a href="../classes/SiteQueryService.html">SiteQueryService</a></li>
                                <li><a href="../classes/SiteService.html">SiteService</a></li>
                                <li><a href="../classes/SlideShareMediaRenderer.html">SlideShareMediaRenderer</a></li>
                                <li><a href="../classes/StorifyMediaRenderer.html">StorifyMediaRenderer</a></li>
                                <li><a href="../classes/System.html">System</a></li>
                                <li><a href="../classes/TemplateEntityService.html">TemplateEntityService</a></li>
                                <li><a href="../classes/TemplateService.html">TemplateService</a></li>
                                <li><a href="../classes/TemplateValue.html">TemplateValue</a></li>
                                <li><a href="../classes/TokenAuthentication.html">TokenAuthentication</a></li>
                                <li><a href="../classes/TokenService.html">TokenService</a></li>
                                <li><a href="../classes/TopicService.html">TopicService</a></li>
                                <li><a href="../classes/TopMenuService.html">TopMenuService</a></li>
                                <li><a href="../classes/TrinketMediaRenderer.html">TrinketMediaRenderer</a></li>
                                <li><a href="../classes/TTLIndexHelper.html">TTLIndexHelper</a></li>
                                <li><a href="../classes/UrlService.html">UrlService</a></li>
                                <li><a href="../classes/UsernamePasswordAuthentication.html">UsernamePasswordAuthentication</a></li>
                                <li><a href="../classes/UserService.html">UserService</a></li>
                                <li><a href="../classes/Util.html">Util</a></li>
                                <li><a href="../classes/ValidationService.html">ValidationService</a></li>
                                <li><a href="../classes/VideoMediaRenderer.html">VideoMediaRenderer</a></li>
                                <li><a href="../classes/View Controller.html">View Controller</a></li>
                                <li><a href="../classes/VimeoMediaRenderer.html">VimeoMediaRenderer</a></li>
                                <li><a href="../classes/VineMediaRenderer.html">VineMediaRenderer</a></li>
                                <li><a href="../classes/YouTubeMediaRenderer.html">YouTubeMediaRenderer</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Admin.html">Admin</a></li>
                                <li><a href="../modules/dao.html">dao</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Entities.html">Entities</a></li>
                                <li><a href="../modules/ErrorSuccess.html">ErrorSuccess</a></li>
                                <li><a href="../modules/Model.html">Model</a></li>
                                <li><a href="../modules/Security.html">Security</a></li>
                                <li><a href="../modules/Services.html">Services</a></li>
                                <li><a href="../modules/Session.html">Session</a></li>
                                <li><a href="../modules/Storage.html">Storage</a></li>
                                <li><a href="../modules/Theme.html">Theme</a></li>
                                <li><a href="../modules/Validation.html">Validation</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: include\service\entities\site_service.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 Copyright (C) 2015  PencilBlue, LLC

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/

var async = require(&#x27;async&#x27;);
var url = require(&#x27;url&#x27;);
var util  = require(&#x27;../../util.js&#x27;);

module.exports = function SiteServiceModule(pb) {
    /**
     * Service for performing site specific operations.
     * @class SiteService
     * @constructor
     */
    function SiteService(context) {
        if (!util.isObject(context)) {
            context = {};
        }

        context.type = TYPE;
        SiteService.super_.call(this, context);
        this.dao = new pb.DAO();
    }
    util.inherits(SiteService, pb.BaseObjectService);

  /**
   * The name of the DB collection where the resources are persisted
   * @private
   * @static
   * @readonly
   * @property TYPE
   * @type {String}
   */
  var TYPE = &#x27;site&#x27;;

    /**
     * represents default configuration, not actually a full site
     * @static
     * @readonly
     * @property GLOBAL_SITE
     * @type {String}
     */
    SiteService.GLOBAL_SITE = &#x27;global&#x27;;

    /**
     * represents a site that doesn&#x27;t exist
     * @static
     * @readonly
     * @property NO_SITE
     * @type {String}
     */
    SiteService.NO_SITE = &#x27;no-site&#x27;;

    /**
     *
     * @static
     * @readonly
     * @property SITE_FIELD
     * @type {String}
     */
    SiteService.SITE_FIELD = &#x27;site&#x27;;

    /**
     *
     * @static
     * @readonly
     * @property SITE_COLLECTION
     * @type {String}
     */
    SiteService.SITE_COLLECTION = &#x27;site&#x27;;

    /**
     *
     * @private
     * @static
     * @readonly
     * @property SITE_COLL
     * @type {String}
     */
    var SITE_COLL = SiteService.SITE_COLLECTION;

    /**
     * Load full site config from the database using the unique id.
     * @method getByUid
     * @param {String} uid - unique id of site
     * @param {Function} cb - the callback function
     */
    SiteService.prototype.getByUid = function(uid, cb) {
        if(!uid || uid === SiteService.GLOBAL_SITE) {
            cb(null, {
                displayName:pb.config.siteName,
                hostname: pb.config.siteRoot,
                uid: SiteService.GLOBAL_SITE,
                defaultLocale: pb.Localization.defaultLocale,
                supportedLocales: {}
            });
        }
        else {
            var dao = new pb.DAO();
            var where = {uid: uid};
            dao.loadByValues(where, SITE_COLL, cb);
        }
    };

    /**
     * Get all of the site objects in the database
     * @method getAllSites
     * @param {Function} cb - the callback function
     */
    SiteService.prototype.getAllSites = function(cb) {
        var dao = new pb.DAO();
        dao.q(SITE_COLL, { select: pb.DAO.SELECT_ALL, where: {} }, cb);
    };

    /**
     * Get all site objects where activated is true.
     * @method getActiveSites
     * @param {Function} cb - the callback function
     */
    SiteService.prototype.getActiveSites = function(cb) {
        var dao = new pb.DAO();
        dao.q(SITE_COLL, { select: pb.DAO.SELECT_ALL, where: {active: true} }, cb);
    };

    /**
     * Get all site objects where activated is false.
     * @method getInactiveSites
     * @param {Function} cb - the callback function
     */
    SiteService.prototype.getInactiveSites = function(cb) {
        var dao = new pb.DAO();
        dao.q(SITE_COLL, {where: {active: false}}, cb);
    };

    /**
     * Get all site objects segmented by active status.
     * @method getSiteMap
     * @param {Function} cb - the callback function
     */
    SiteService.prototype.getSiteMap = function(cb) {
        var self  = this;
        var tasks = {
             active: function(callback) {
                 self.getActiveSites(callback);
             },

             inactive: function(callback) {
                 self.getInactiveSites(callback);
             }
        };
        async.series(tasks, cb);
    };

    /**
     * Get site name given a unique id.
     * @method getSiteNameByUid
     * @param {String} uid - unique id
     * @param {Function} cb - the callback function
     */
    SiteService.prototype.getSiteNameByUid = function(uid, cb) {
        var dao = new pb.DAO();
        dao.q(SITE_COLL, {select: pb.DAO.SELECT_ALL, where: {uid: uid} }, function(err, result) {
            var siteName = (!uid || uid === SiteService.GLOBAL_SITE) ? &#x27;global&#x27; : &#x27;&#x27;;

            if (pb.util.isError(err)) {
                pb.log.error(err);
                return cb(err);
            }
            else if (result &amp;&amp; result.length &gt; 0) {
                siteName = result[0].displayName;
            }
            cb(null, siteName);
        });
    };

    /**
     * Checks to see if a proposed site display name or hostname is already in the system
     * @method isDisplayNameOrHostnameTaken
     * @param {String}   displayName - desired name to display
     * @param {String}   hostname - hostname of the site
     * @param {String}   id - Site object Id to exclude from the search
     * @param {Function} cb - Callback function
     */
    SiteService.prototype.isDisplayNameOrHostnameTaken = function(displayName, hostname, id, cb) {
        this.getExistingDisplayNameHostnameCounts(displayName, hostname, id, function(err, results) {

            var result = results === null;
            if (!result) {
                util.forEach(results, function(value) {
                    result |= value &gt; 0;
                });
            }
            cb(err, result);
        });
    };

    /**
     * Gets the total counts of a display name and hostname in the site collection
     *
     * @method getExistingDisplayNameHostnameCounts
     * @param {String}   displayName - site display name
     * @param {String}   hostname - site hostname
     * @param {String}   id - Site object Id to exclude from the search
     * @param {Function} cb - Callback function
     */
    SiteService.prototype.getExistingDisplayNameHostnameCounts = function(displayName, hostname, id, cb) {
        if (util.isFunction(id)) {
            cb = id;
            id = null;
        }

        var getWhere = function(where) {
            if (id) {
                where[pb.DAO.getIdField()] = pb.DAO.getNotIdField(id);
            }
            return where;
        };
        var dao   = new pb.DAO();
        var tasks = {
            displayName: function(callback) {
                var expStr = &#x27;^&#x27; + util.escapeRegExp(displayName.toLowerCase()) + &#x27;$&#x27;;
                dao.count(&#x27;site&#x27;, getWhere({displayName: new RegExp(expStr, &#x27;i&#x27;)}), callback);
            },
            hostname: function(callback) {
                dao.count(&#x27;site&#x27;, getWhere({hostname: hostname.toLowerCase()}), callback);
            }
        };
        async.parallel(tasks, cb);
    };

    /**
     * Run a job to activate a site so that all of its routes are available.
     * @method activateSite
     * @param {String} siteUid - site unique id
     * @param {Function} cb - callback to run after job is completed
     * @return {String} the job id
     */
    SiteService.prototype.activateSite = function(siteUid, cb) {
        cb = cb || util.cb;
        var name = util.format(&quot;ACTIVATE_SITE_%s&quot;, siteUid);
        var job = new pb.SiteActivateJob();
        job.setRunAsInitiator(true);
        job.init(name);
        job.setSite({uid: siteUid});
        job.run(cb);
        return job.getId();
    };


    /**
     * Run a job to set a site inactive so that only the admin routes are available.
     * @method deactivateSite
     * @param {String} siteUid - site unique id
     * @param {Function} cb - callback to run after job is completed
     * @return {String} the job id
     */
    SiteService.prototype.deactivateSite = function(siteUid, cb) {
        cb = cb || util.cb;
        var name = util.format(&quot;DEACTIVATE_SITE_%s&quot;, siteUid);
        var job = new pb.SiteDeactivateJob();
        job.setRunAsInitiator(true);
        job.init(name);
        job.setSite({uid: siteUid});
        job.run(cb);
        return job.getId();
    };

    /**
     * Run a job to update a site&#x27;s hostname and/or displayname.
     * @method editSite
     * @param {Object} options - object containing site fields
     * @param {String} options.uid - site uid
     * @param {String} options.hostname - result of site hostname edit/create
     * @param {String} options.displayName - result of site display name edit/create
     * @param {Function} cb - callback to run after job is completed
     * @return {String} the job id
     */
    SiteService.prototype.editSite = function(options, cb) {
        cb = cb || util.cb;
        var name = util.format(&quot;EDIT_SITE%s&quot;, options.site);
        var job = new pb.SiteCreateEditJob();
        job.setRunAsInitiator(true);
        job.init(name);
        job.setSite(options);
        job.run(cb);
        return job.getId();
    };

    /**
     * Creates a site and saves it to the database.
     * @method createSite
     * @param {Object} options - object containing site fields
     * @param {String} options.uid - site unique id
     * @param {String} options.hostname - result of site hostname edit/create
     * @param {String} options.displayName - result of site display name edit/create
     * @param {String} id - the site unique identifier for the database
     * @param {Function} cb - callback function
     */
    SiteService.prototype.createSite = function(options, cb) {
        cb = cb || util.cb;
        options.active = false;
        options.uid = util.uniqueId();
        return this.editSite(options, cb);
    };

    /**
     * Given a site uid, activate if the site exists so that user facing routes are on.
     * @method startAcceptingSiteTraffic
     * @param {String} siteUid - site unique id
     * @param {Function} cb - callback function
     */
    SiteService.prototype.startAcceptingSiteTraffic = function(siteUid, cb) {
        var dao = new pb.DAO();
        dao.loadByValue(&#x27;uid&#x27;, siteUid, &#x27;site&#x27;, function(err, site) {
            if(util.isError(err)) {
                cb(err, null);
            }
            else if (!site) {
                cb(new Error(&#x27;Site not found&#x27;), null);
            }
            else if (!site.active) {
                cb(new Error(&#x27;Site not active&#x27;), null);
            }
            else {
                pb.RequestHandler.activateSite(site);
                cb(err, site);
            }
        });
    };

    /**
     * Given a site uid, deactivate if the site exists so that user facing routes are off.
     * @method stopAcceptingSiteTraffic
     * @param {String} siteUid - site unique id
     * @param {Function} cb - callback function
     */
    SiteService.prototype.stopAcceptingSiteTraffic = function(siteUid, cb) {
        var dao = new pb.DAO();
        dao.loadByValue(&#x27;uid&#x27;, siteUid, &#x27;site&#x27;, function(err, site) {
            if(util.isError(err)) {
                cb(err, null);
            }
            else if (!site) {
                cb(new Error(&#x27;Site not found&#x27;), null);
            }
            else if (site.active) {
                cb(new Error(&#x27;Site not deactivated&#x27;), null);
            }
            else {
                pb.RequestHandler.deactivateSite(site);
                cb(err, site);
            }
        });
    };

    /**
     * Load all sites into memory.
     * @method initSites
     * @param {Function} cb
     */
    SiteService.prototype.initSites = function(cb) {
        if (pb.config.multisite.enabled &amp;&amp; !pb.config.multisite.globalRoot) {
            return cb(new Error(&quot;A Global Hostname must be configured with multisite turned on.&quot;), false);
        }
        this.getAllSites(function (err, results) {
            if (err) {
                return cb(err);
            }

            var defaultLocale = pb.Localization.getDefaultLocale();
            var defaultSupportedLocales = {};
            defaultSupportedLocales[defaultLocale] = true;
            //only load the sites when we are in multi-site mode
            if (pb.config.multisite.enabled) {
                util.forEach(results, function (site) {
                    site.defaultLocale = site.defaultLocale || defaultLocale;
                    site.supportedLocales = site.supportedLocales || defaultSupportedLocales;
                    site.prevHostnames = site.prevHostnames || [];
                    pb.RequestHandler.loadSite(site);
                });
            }

            // To remain backwards compatible, hostname is siteRoot for single tenant
            // and active allows all routes to be hit.
            // When multisite, use the configured hostname for global, turn off public facing routes,
            // and maintain admin routes (active is false).
            pb.RequestHandler.loadSite(SiteService.getGlobalSiteContext());
            cb(err, true);
        });
    };

    /**
     * Runs a site activation job when command is received.
     * @static
     * @method onActivateSiteCommandReceived
     * @param {Object} command - the command to react to.
     */
    SiteService.onActivateSiteCommandReceived = function(command) {
        if (!util.isObject(command)) {
            pb.log.error(&#x27;SiteService: an invalid activate_site command object was passed. %s&#x27;, util.inspect(command));
            return;
        }

        var name = util.format(&quot;ACTIVATE_SITE_%s&quot;, command.site);
        var job = new pb.SiteActivateJob();
        job.setRunAsInitiator(false);
        job.init(name, command.jobId);
        job.setSite(command.site);
        job.run(function(err, result) {
            var response = {
                error: err ? err.stack : undefined,
                result: result ? true : false
            };
            pb.CommandService.getInstance().sendInResponseTo(command, response);
        });
    };

    /**
     * Runs a site deactivation job when command is received.
     * @static
     * @method onDeactivateSiteCommandReceived
     * @param {Object} command - the command to react to.
     */
    SiteService.onDeactivateSiteCommandReceived = function(command) {
        if (!util.isObject(command)) {
            pb.log.error(&#x27;SiteService: an invalid deactivate_site command object was passed. %s&#x27;, util.inspect(command));
            return;
        }

        var name = util.format(&quot;DEACTIVATE_SITE_%s&quot;, command.site);
        var job = new pb.SiteDeactivateJob();
        job.setRunAsInitiator(false);
        job.init(name, command.jobId);
        job.setSite(command.site);
        job.run(function(err, result) {
            var response = {
                error: err ? err.stack : undefined,
                result: result ? true : false
            };
            pb.CommandService.getInstance().sendInResponseTo(command, response);
        });
    };

    /**
     * Runs a site deactivation job when command is received.
     * @static
     * @method onCreateEditSiteCommandReceived
     * @param {Object} command - the command to react to.
     */
    SiteService.onCreateEditSiteCommandReceived = function(command) {
        if (!util.isObject(command)) {
            pb.log.error(&#x27;SiteService: an invalid create_edit_site command object was passed. %s&#x27;, util.inspect(command));
            return;
        }

        var name = util.format(&quot;CREATE_EDIT_SITE%s&quot;, command.site);
        var job = new pb.SiteCreateEditJob();
        job.setRunAsInitiator(false);
        job.init(name, command.jobId);
        job.setSite(command.site);
        job.run(function(err, result) {
            var response = {
                error: err ? err.stack : undefined,
                result: result ? true : false
            };
            pb.CommandService.getInstance().sendInResponseTo(command, response);
        });
    };

    /**
     * Register activate and deactivate commands on initialization
     * @static
     * @method init
     */
    SiteService.init = function() {
        var commandService = pb.CommandService.getInstance();
        commandService.registerForType(&#x27;activate_site&#x27;, SiteService.onActivateSiteCommandReceived);
        commandService.registerForType(&#x27;deactivate_site&#x27;  , SiteService.onDeactivateSiteCommandReceived);
        commandService.registerForType(&#x27;create_edit_site&#x27;, SiteService.onCreateEditSiteCommandReceived);
    };

    /**
     * Returns true if siteid given is global or non-existant (to remain backwards compatible)
     * @method isGlobal
     * @param {String} siteid - the site id to check
     * @return {Boolean} true if global or does not exist
     */
    SiteService.isGlobal = function (siteid) {
        return (!siteid || siteid === SiteService.GLOBAL_SITE);
    };

    /**
     * Returns true if both site ids given are equal
     * @method areEqual
     * @param {String} siteA - first site id to compare
     * @param {String} siteB - second site id to compare
     * @return {Boolean} true if equal, false otherwise
     */
    SiteService.areEqual = function (siteA, siteB) {
        if (SiteService.isGlobal(siteA) &amp;&amp; SiteService.isGlobal(siteB)) {
            return true;
        }
        return siteA === siteB;
    };

    /**
     * Returns true if actual is not set (falsey) or logically equivalent to expected in terms of sites
     * @method isNotSetOrEqual
     * @param {String} actual - site to check
     * @param {String} expected - site you expect to be equal
     * @return {Boolean} true if actual exists and equals expected
     */
    SiteService.isNotSetOrEqual = function (actual, expected) {
        return !actual || SiteService.areEqual(actual, expected);
    };

    /**
     * Central place to get the current site. Backwards compatible cleansing
     * @method getCurrentSite
     * @param {String} siteid - site is to cleanse
     * @return {String} SiteService.GLOBAL_SITE if not specified, or siteid otherwise
     */
    SiteService.getCurrentSite = function (siteid) {
        return siteid || SiteService.GLOBAL_SITE;
    };

    /**
     * Return site field from object.
     * @method getSiteFromObject
     * @param {Object} object
     * @return {String} the value of the object&#x27;s site field key
     */
    SiteService.getSiteFromObject = function (object) {
        if (!object) {
            return SiteService.NO_SITE;
        }
        return object[SiteService.SITE_FIELD];
    };

    /**
     * Determine whether http or https is being used for the site and return hostname attached to http(s)
     * @method getHostWithProtocol
     * @param {String} hostname
     * @return {String} hostname with protocol attached
     */
    SiteService.getHostWithProtocol = function(hostname) {
        hostname = hostname.match(/^http/g) ? hostname : &quot;//&quot; + hostname;
        var urlObject = url.parse(hostname, false, true);
        urlObject.protocol = pb.config.server.ssl.enabled ? &#x27;https&#x27; : &#x27;http&#x27;;
        return url.format(urlObject).replace(/\/$/, &#x27;&#x27;);
    };

    /**
     * @method deleteSiteSpecificContent
     * @param {String} siteId
     * @param {Function} cb
     */
    SiteService.prototype.deleteSiteSpecificContent = function (siteid, cb) {
        var siteQueryService = new pb.SiteQueryService();
        siteQueryService.getCollections(function(err, allCollections) {
            var dao = new pb.DAO();

            var tasks = util.getTasks(allCollections, function (collections, i) {
                return function (taskCallback) {
                    dao.delete({site: siteid}, collections[i].name, function (err, commandResult) {
                        if (util.isError(err) || !commandResult) {
                            return taskCallback(err);
                        }

                        taskCallback(null, {collection: collections[i].name});
                    });
                };
            });
            async.parallel(tasks, function (err, results) {
                if (pb.util.isError(err)) {
                    pb.log.error(err);
                    return cb(err);
                }
                pb.log.silly(&quot;Successfully deleted site %s from database&quot;, siteid);
                cb(null, results);
            });
        });
    };

    /**
     * Retrieves the global site context
     * @static
     * @method getGlobalSiteContext
     * @return {Object}
     */
    SiteService.getGlobalSiteContext = function() {
        return {
            displayName: pb.config.siteName,
            uid: pb.SiteService.GLOBAL_SITE,
            hostname: pb.config.multisite.enabled ? url.parse(pb.config.multisite.globalRoot).host : url.parse(pb.config.siteRoot).host,
            active: pb.config.multisite.enabled ? false : true,
            defaultLocale: pb.Localization.getDefaultLocale(),
            supportedLocales: util.arrayToObj(pb.Localization.getSupported(), function(a, i) { return a[i]; }, function() { return true; }),
            prevHostnames: []
        };
    };

    SiteService.buildPrevHostnames = function(data, object) {
        var prevHostname = object.hostname;
        var newHostname = data.hostname;
        // If this site&#x27;s hostname has been changed, save off a redirectHost
        if ((prevHostname &amp;&amp; newHostname) &amp;&amp; (prevHostname !== newHostname)) {
            // Check for circular hostname references
            data.prevHostnames = data.prevHostnames.filter(function (hostname) {
                return hostname !== newHostname;
            });
            data.prevHostnames.push(prevHostname);
            pb.RequestHandler.redirectHosts[prevHostname] = newHostname;
            pb.RequestHandler.sites[prevHostname] = null;
        }
        return data;
    };

    SiteService.merge = function (context, cb) {
        if (!context.data.prevHostnames) {
            context.data.prevHostnames = [];
        }
        context.data = SiteService.buildPrevHostnames(context.data, context.object);

        pb.util.merge(context.data, context.object);
        cb(null);
    };

    SiteService.beforeDelete = function (context, cb) {
        var siteid = context.data.uid;
        context.service.deleteSiteSpecificContent(siteid, cb);
    };

    pb.BaseObjectService.on(TYPE + &#x27;.&#x27; + pb.BaseObjectService.MERGE, SiteService.merge);
    pb.BaseObjectService.on(TYPE + &#x27;.&#x27; + pb.BaseObjectService.BEFORE_DELETE, SiteService.beforeDelete);

    return SiteService;
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
