<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controllers\admin\plugins\settings.js - PencilBlue</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://pencilblue.org/img/pb_logo.png" title="PencilBlue"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.3</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AdminIndexController.html">AdminIndexController</a></li>
            
                <li><a href="../classes/AdminNavigation.html">AdminNavigation</a></li>
            
                <li><a href="../classes/AdminSubnavService.html">AdminSubnavService</a></li>
            
                <li><a href="../classes/ArticleService.html">ArticleService</a></li>
            
                <li><a href="../classes/BaseController.html">BaseController</a></li>
            
                <li><a href="../classes/CacheEntityService.html">CacheEntityService</a></li>
            
                <li><a href="../classes/CacheFactory.html">CacheFactory</a></li>
            
                <li><a href="../classes/ClientJS.html">ClientJS</a></li>
            
                <li><a href="../classes/ClusterApiController.html">ClusterApiController</a></li>
            
                <li><a href="../classes/CommentService.html">CommentService</a></li>
            
                <li><a href="../classes/ContentService.html">ContentService</a></li>
            
                <li><a href="../classes/DAO.html">DAO</a></li>
            
                <li><a href="../classes/DBEntityService.html">DBEntityService</a></li>
            
                <li><a href="../classes/DBManager.html">DBManager</a></li>
            
                <li><a href="../classes/DocumentCreator.html">DocumentCreator</a></li>
            
                <li><a href="../classes/EmailService.html">EmailService</a></li>
            
                <li><a href="../classes/FormController.html">FormController</a></li>
            
                <li><a href="../classes/FSEntityService.html">FSEntityService</a></li>
            
                <li><a href="../classes/JSONFSEntityService.html">JSONFSEntityService</a></li>
            
                <li><a href="../classes/Localization.html">Localization</a></li>
            
                <li><a href="../classes/ManageComments.html">ManageComments</a></li>
            
                <li><a href="../classes/MediaLoader.html">MediaLoader</a></li>
            
                <li><a href="../classes/MediaService.html">MediaService</a></li>
            
                <li><a href="../classes/MemoryEntityService.html">MemoryEntityService</a></li>
            
                <li><a href="../classes/MongoRegistrationProvider.html">MongoRegistrationProvider</a></li>
            
                <li><a href="../classes/MongoSessionStore.html">MongoSessionStore</a></li>
            
                <li><a href="../classes/PageController.html">PageController</a></li>
            
                <li><a href="../classes/PBError.html">PBError</a></li>
            
                <li><a href="../classes/PencilBlue.html">PencilBlue</a></li>
            
                <li><a href="../classes/PluginPublicContentController.html">PluginPublicContentController</a></li>
            
                <li><a href="../classes/PluginService.html">PluginService</a></li>
            
                <li><a href="../classes/ReadOnlySimpleLayeredService.html">ReadOnlySimpleLayeredService</a></li>
            
                <li><a href="../classes/RedisRegistrationProvider.html">RedisRegistrationProvider</a></li>
            
                <li><a href="../classes/RedisSessionStore.html">RedisSessionStore</a></li>
            
                <li><a href="../classes/SaveArticleDraft.html">SaveArticleDraft</a></li>
            
                <li><a href="../classes/SecurityService.html">SecurityService</a></li>
            
                <li><a href="../classes/ServerRegistration.html">ServerRegistration</a></li>
            
                <li><a href="../classes/SessionHandler.html">SessionHandler</a></li>
            
                <li><a href="../classes/SimpleLayeredService.html">SimpleLayeredService</a></li>
            
                <li><a href="../classes/TemplateService.html">TemplateService</a></li>
            
                <li><a href="../classes/TopMenuService.html">TopMenuService</a></li>
            
                <li><a href="../classes/UrlService.html">UrlService</a></li>
            
                <li><a href="../classes/UserService.html">UserService</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
                <li><a href="../classes/ValidationService.html">ValidationService</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Admin.html">Admin</a></li>
            
                <li><a href="../modules/Database.html">Database</a></li>
            
                <li><a href="../modules/Entities.html">Entities</a></li>
            
                <li><a href="../modules/ErrorSuccess.html">ErrorSuccess</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/Security.html">Security</a></li>
            
                <li><a href="../modules/Services.html">Services</a></li>
            
                <li><a href="../modules/Session.html">Session</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/Theme.html">Theme</a></li>
            
                <li><a href="../modules/Validation.html">Validation</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: controllers\admin\plugins\settings.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
	Copyright (C) 2014  PencilBlue, LLC

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/

/**
* Interface for changing a plugin&#x27;s settings
*/

function PluginSettingsController(){}

//dependencies
var BaseController = pb.BaseController;

//inheritance
util.inherits(PluginSettingsController, BaseController);

//statics
var SUB_NAV_KEY = &#x27;plugin_settings&#x27;;

PluginSettingsController.prototype.render = function(cb) {
	if (this.req.method !== &#x27;GET&#x27; &amp;&amp; this.req.method !== &#x27;POST&#x27;) {
		var data = {
			code: 405,
			headers: {
				Allow: &#x27;GET, POST&#x27;
			},
			content: this.ls.get(&#x27;INVALID_METHOD&#x27;)
		};
		cb(data);
		return;
	}

	var self = this;
	switch(this.req.method) {
	case &#x27;GET&#x27;:
		this.renderGet(cb);
		break;
	case &#x27;POST&#x27;:
		this.getPostParams(function(err, post) {
			self.renderPost(post, cb);
		});
		break;
	default:
		throw new Error(this.ls.get(&#x27;INVALID_METHOD&#x27;));
	}
};

PluginSettingsController.prototype.renderGet = function(cb) {
	var self = this;

	var uid = this.pathVars.id;
	pb.plugins.getPlugin(uid, function(err, plugin) {
		if (util.isError(err)) {
			throw err;
		}
		else if (plugin === null) {
			self.reqHandler.serve404();
			return;
		}

		//retrieve settings
		self.plugin = plugin;
		self.getSettings(uid, function(err, settings) {
			if (util.isError(err)) {
				throw err;
			}
			else if (settings === null) {
				self.reqHandler.serve404();
				return;
			}

			var clone = pb.utils.copyArray(settings);
			for (var i = 0; i &lt; clone.length; i++) {
				var item = clone[i];

				item.displayName = item.name.split(&#x27;_&#x27;).join(&#x27; &#x27;);
				item.displayName = item.displayName.charAt(0).toUpperCase() + item.displayName.slice(1);

				if (item.value === true || item.value === false) {
					item.type = &#x27;checkbox&#x27;;
				}
				else if (pb.utils.isString(item.value)) {
					item.type = &#x27;text&#x27;;
				}
				else if (!isNaN()) {
					item.type = &#x27;number&#x27;;
				}
			}

			var tabs = [
				{
					active: &#x27;active&#x27;,
					href: &#x27;#plugin_settings&#x27;,
					icon: &#x27;cog&#x27;,
					title: self.ls.get(&#x27;SETTINGS&#x27;)
				}
			];

			//setup angular
			var angularData = pb.js.getAngularController(
	            {
	            	pills: pb.AdminSubnavService.get(SUB_NAV_KEY, self.ls, null, plugin),
					tabs: tabs,
	                navigation: pb.AdminNavigation.get(self.session, [&#x27;plugins&#x27;, &#x27;manage&#x27;], self.ls),
	                settings: clone
	            },
	            []
	        );

			//render page
			self.ts.registerLocal(&#x27;form_refill&#x27;, function(flag, cb) {
				self.checkForFormRefill(&#x27; &#x27;, function(refill) {
					cb(null, refill);
				});
			});
			self.ts.registerLocal(&#x27;form_action&#x27;, self.getFormAction(uid));
			self.ts.load(&#x27;/admin/plugins/settings&#x27;, function(err, content) {

				//TODO move angular out as flag &amp; replacement when can add option to
				//skip the check for replacements in replacement
				content = content.replace(&#x27;^angular_script^&#x27;, angularData);
				cb({content: content});
			});
		});
	});
};

PluginSettingsController.prototype.getFormAction = function(uid) {
	return this.req.url;
};

PluginSettingsController.prototype.getPageName = function() {
	return this.plugin.name + &#x27; - &#x27; + this.ls.get(&#x27;SETTINGS&#x27;);
};

PluginSettingsController.prototype.getSettings = function(uid, cb) {
	pb.plugins.getSettings(uid, cb);
};

PluginSettingsController.prototype.setSettings = function(settings, uid, cb) {
	pb.plugins.setSettings(settings, uid, cb);
};

PluginSettingsController.prototype.renderPost = function(post, cb) {
	var self = this;

	//retrieve settings
	var uid = this.pathVars.id;
	this.getSettings(uid, function(err, settings) {
		if (util.isError(err)) {
			throw err;
		}
		else if (settings === null) {
			self.reqHandler.serve404();
			return;
		}

		var errors = [];
		for (var i = 0; i &lt; settings.length; i++) {

			var currItem = settings[i];
			var newVal   = post[currItem.name];
			var type     = PluginSettingsController.getValueType(currItem.value);console.log(util.format(&#x27;N=[%s] OV=[%s] NV=[%s] T=[%s]&#x27;, currItem.name, currItem.value, newVal, type));
			if (newVal === undefined || null) {
				if (type === &#x27;boolean&#x27;) {
					newVal = false;
				}
				else {
					errors.push(util.format(&quot;The %s setting must be provided&quot;, currItem.name));
					continue;
				}
			}

			//validate the value
			if (!PluginSettingsController.validateValue(newVal, type)) {
				errors.push(util.format(&quot;The value [%s] for setting %s is not a valid %s&quot;, newVal, currItem.name, type));
				continue;
			}

			//set the new value
			currItem.value = PluginSettingsController.formatValue(newVal, type);
		}

		//handle errors
		if (errors.length &gt; 0) {
			self.session.error = errors.join(&quot;\n&quot;);
			self.setFormFieldValues(post);
			self.redirect(self.req.url, cb);
			return;
		}

		//persist new settings
		self.setSettings(settings, uid, function(err, result) {
			if (util.isError(err)) {
				throw err;
			}

			//set for success and redirect
			if (result) {
				self.session.success = self.ls.get(&#x27;SAVE_PLUGIN_SETTINGS_SUCCESS&#x27;);
			}
			else {
				self.session.error = self.ls.get(&#x27;SAVE_PUGIN_SETTINGS_FAILURE&#x27;);
			}
			self.redirect(self.req.url, cb);
		});
	});
};

PluginSettingsController.prototype.getBackUrl = function() {
	return &#x27;/admin/plugins/&#x27;;
};

PluginSettingsController.geSubNavItems = function(key, ls, data) {
	return [
        {
            name: &#x27;manage_plugins&#x27;,
			title: data.name + &#x27; &#x27; + ls.get(&#x27;SETTINGS&#x27;),
			icon: &#x27;chevron-left&#x27;,
			href: &#x27;/admin/plugins&#x27;
        }
	];
};

PluginSettingsController.getValueInputType = function(value) {
	var type = &#x27;&#x27;;
	if (value === true || value === false) {
		type = &#x27;checkbox&#x27;;
	}
	else if (pb.utils.isString(value)) {
		type = &#x27;text&#x27;;
	}
	else if (!isNaN(value)) {
		type = &#x27;number&#x27;;
	}
	return type;
};

PluginSettingsController.getValueType = function(value) {
	var type = &#x27;&#x27;;
	if (value === true || value === false) {
		type = &#x27;boolean&#x27;;
	}
	else if (pb.utils.isString(value)) {
		type = &#x27;string&#x27;;
	}
	else if (!isNaN(value)) {
		type = &#x27;number&#x27;;
	}
	return type;
};

PluginSettingsController.validateValue = function(value, type) {
	if (type === &#x27;boolean&#x27;) {
		return value !== null &amp;&amp; value !== undefined &amp;&amp; (value === true || value === false || value === 1 || value === 0 || value == &#x27;1&#x27; || value === &#x27;0&#x27; || value.toLowerCase() === &#x27;true&#x27; || value.toLowerCase() === &#x27;false&#x27;);
	}
	else if (type === &#x27;string&#x27;) {
		return pb.validation.validateStr(value, true);
	}
	else if (type === &#x27;number&#x27;) {
		return !isNaN(value);
	}
	return false;
};

PluginSettingsController.formatValue = function(value, type) {
	if (value === null || value === undefined || type === null || type === undefined) {
		throw new Error(&quot;Value and type must be provided&quot;);
	}

	if (type === &#x27;boolean&#x27;) {
		switch(value) {
		case true:
		case 1:
		case &#x27;1&#x27;:
			return true;
		case false:
		case 0:
		case &#x27;0&#x27;:
			return false;
		}

		if (pb.utils.isString(value)) {
			value = value.toLowerCase();
			return value === &#x27;true&#x27;;
		}
		else {
			return null;
		}
	}
	else if (type === &#x27;string&#x27;) {
		return &#x27;&#x27; + value;
	}
	else if (type === &#x27;number&#x27;) {
		return Number(value);
	}
	return null;
};

//register admin sub-nav
pb.AdminSubnavService.registerFor(SUB_NAV_KEY, PluginSettingsController.geSubNavItems);

//exports
module.exports = PluginSettingsController;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
